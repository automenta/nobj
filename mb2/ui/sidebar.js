import $ from "jquery";
import ObjViewMini from './obj.view.mini';
import MeView from "./me.view";
import FriendsView from "./Friends.view";
import NetView from "./net.view.js";
import DBView from "./db.view.js";
import MatchingView from "./match.view.js";
import '/ui/css/sidebar.css';
class PageContextMenu {
    ele;
    db;
    sidebar;
    selectedPageId;
    constructor(db, app) {
        this.db = db;
        this.sidebar = app;
        this.selectedPageId = null;
        this.ele = $('<div>').addClass('context-menu').html(`
            <ul>
                <li data-action="rename-page">Rename</li>
                <li data-action="delete-page">Delete</li>
            </ul>
        `);
        //handle clicks outside the menu
        // $(this.ele).click(e => {
        //     if (!this.ele.has(e.target).length)
        //         this.hide();
        // });
        $(document).click(e => {
            if (!$(e.target).closest('#context-menu').length)
                this.hide();
        });
        this.ele.on('click', 'li', e => {
            const action = $(e.target).data('action');
            if (!action)
                return;
            if (action === 'rename-page')
                this.renamePage();
            else if (action === 'delete-page')
                this.deletePage();
            this.hide();
        });
    }
    renamePage() {
        if (this.selectedPageId) {
            const newName = prompt('Enter new page name:');
            if (newName)
                this.db.objName(this.selectedPageId, newName);
        }
    }
    deletePage() {
        if (this.selectedPageId && confirm('Are you sure you want to delete this page?')) {
            this.db.delete(this.selectedPageId);
            if (this.db.get(this.selectedPageId)?.public)
                this.sidebar.app.net.unshareDocument(this.selectedPageId);
        }
    }
    showContextMenu(event, pageId) {
        event.preventDefault();
        this.selectedPageId = pageId;
        this.ele.css({
            top: event.clientY,
            left: event.clientX,
            display: 'block'
        });
    }
    hide() {
        this.ele.hide();
    }
}
export default class Sidebar {
    ele;
    db;
    meView;
    friendsView;
    netView;
    dbView;
    matchingView;
    app;
    contextMenu;
    pageList;
    constructor(app) {
        const root = app.ele;
        this.ele = $('<div>').addClass('sidebar');
        this.app = app;
        this.db = app.db;
        const thisAware = app.awareness.bind(app);
        this.meView = new MeView(root, app.user.bind(app), thisAware);
        this.friendsView = new FriendsView(root, thisAware);
        this.netView = new NetView(root.find('.main-view'), app.net);
        this.dbView = new DBView(root, this.db);
        this.matchingView = new MatchingView(root, app.match);
        this.ele.append(this.menu());
        this.contextMenu = new PageContextMenu(this.db, this);
        root.append(this.contextMenu.ele);
        this.ele.append(this.pageList = $('<ul>', { class: 'page-list' }));
        this.db.index.observe(() => this.updatePageList());
        this.updatePageList();
    }
    menu() {
        const menuBar = $('<div>', {
            class: 'menubar'
        }).append($('<button>', {
            class: 'menubar-button add-page-button',
            text: '+',
            title: 'Add New Page'
        }).click(() => {
            const p = this.db.create();
            p.name = 'Empty';
            p.public = false;
            this.app.editor.view(p);
        }));
        [
            { id: 'profile', title: 'Me' },
            { id: 'friends', title: 'Friends' },
            { id: 'network', title: 'Net' },
            { id: 'database', title: 'DB' },
            { id: 'matching', title: 'Matching' },
        ].forEach(view => {
            let v;
            switch (view.id) {
                case 'profile':
                    v = this.meView;
                    break;
                case 'friends':
                    v = this.friendsView;
                    break;
                case 'network':
                    v = this.netView;
                    break;
                case 'database':
                    v = this.dbView;
                    break;
                case 'matching':
                    v = this.matchingView;
                    break;
                default: console.warn(`No page class defined for ${view.id}`);
            }
            menuBar.append($('<button>', {
                class: 'menubar-button',
                text: view.title,
                title: view.title
            }).click(() => v.render()));
        });
        return menuBar;
    }
    updatePageList() {
        const nextPageList = [];
        this.db.index.forEach((_value, key) => {
            const obj = this.db.get(key);
            if (obj) {
                const v = new ObjViewMini(obj);
                v.ele.attr('data-page-id', key)
                    .on('contextmenu', (e) => {
                    e.preventDefault();
                    this.contextMenu.showContextMenu(e, key);
                })
                    .on('click', () => {
                    this.app.editor.view(obj);
                });
                nextPageList.push(v.ele);
            }
        });
        this.pageList.empty().append(nextPageList);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2lkZWJhci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInNpZGViYXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxDQUFDLE1BQU0sUUFBUSxDQUFDO0FBSXZCLE9BQU8sV0FBVyxNQUFNLGlCQUFpQixDQUFBO0FBRXpDLE9BQU8sTUFBTSxNQUFNLFdBQVcsQ0FBQztBQUMvQixPQUFPLFdBQVcsTUFBTSxnQkFBZ0IsQ0FBQztBQUN6QyxPQUFPLE9BQU8sTUFBTSxlQUFlLENBQUM7QUFDcEMsT0FBTyxNQUFNLE1BQU0sY0FBYyxDQUFDO0FBQ2xDLE9BQU8sWUFBWSxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8scUJBQXFCLENBQUM7QUFFN0IsTUFBTSxlQUFlO0lBQ1IsR0FBRyxDQUFTO0lBQ2IsRUFBRSxDQUFLO0lBQ1AsT0FBTyxDQUFVO0lBQ2pCLGNBQWMsQ0FBUztJQUUvQixZQUFZLEVBQUssRUFBRSxHQUFXO1FBQzFCLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLE9BQU8sR0FBRyxHQUFHLENBQUM7UUFDbkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFDM0IsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxDQUFDLElBQUksQ0FBQzs7Ozs7U0FLbkQsQ0FBQyxDQUFDO1FBRUgsZ0NBQWdDO1FBQ2hDLDJCQUEyQjtRQUMzQiwwQ0FBMEM7UUFDMUMsdUJBQXVCO1FBQ3ZCLE1BQU07UUFDTixDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFO1lBQ2xCLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxNQUFNO2dCQUM1QyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDcEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFO1lBQzNCLE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzFDLElBQUksQ0FBQyxNQUFNO2dCQUFFLE9BQU87WUFDcEIsSUFBSSxNQUFNLEtBQUssYUFBYTtnQkFBRSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7aUJBQzNDLElBQUksTUFBTSxLQUFLLGFBQWE7Z0JBQUUsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ3JELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNoQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxVQUFVO1FBQ04sSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7WUFDdEIsTUFBTSxPQUFPLEdBQUcsTUFBTSxDQUFDLHNCQUFzQixDQUFDLENBQUM7WUFDL0MsSUFBSSxPQUFPO2dCQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDL0QsQ0FBQztJQUNMLENBQUM7SUFFRCxVQUFVO1FBQ04sSUFBSSxJQUFJLENBQUMsY0FBYyxJQUFJLE9BQU8sQ0FBQyw0Q0FBNEMsQ0FBQyxFQUFFLENBQUM7WUFDL0UsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1lBQ3BDLElBQUksSUFBSSxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFLE1BQU07Z0JBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDNUcsQ0FBQztJQUNMLENBQUM7SUFFRCxlQUFlLENBQUMsS0FBc0IsRUFBRSxNQUFhO1FBQ2pELEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsY0FBYyxHQUFHLE1BQU0sQ0FBQztRQUM3QixJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztZQUNULEdBQUcsRUFBRSxLQUFLLENBQUMsT0FBTztZQUNsQixJQUFJLEVBQUUsS0FBSyxDQUFDLE9BQU87WUFDbkIsT0FBTyxFQUFFLE9BQU87U0FDbkIsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELElBQUk7UUFDQSxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3BCLENBQUM7Q0FDSjtBQUlELE1BQU0sQ0FBQyxPQUFPLE9BQU8sT0FBTztJQUNmLEdBQUcsQ0FBUztJQUNKLEVBQUUsQ0FBSztJQUNQLE1BQU0sQ0FBUztJQUNmLFdBQVcsQ0FBYztJQUN6QixPQUFPLENBQVU7SUFDakIsTUFBTSxDQUFTO0lBQ2YsWUFBWSxDQUFlO0lBQ3JDLEdBQUcsQ0FBTTtJQUNSLFdBQVcsQ0FBa0I7SUFDN0IsUUFBUSxDQUFTO0lBRXpCLFlBQVksR0FBTztRQUNmLE1BQU0sSUFBSSxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUM7UUFFckIsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBRTFDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1FBQ2YsSUFBSSxDQUFDLEVBQUUsR0FBRyxHQUFHLENBQUMsRUFBRSxDQUFDO1FBRWpCLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFDLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQzlELElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxXQUFXLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3BELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDN0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxZQUFZLEdBQUcsSUFBSSxZQUFZLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUd0RCxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM3QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDdEQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWxDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxFQUFDLEtBQUssRUFBRSxXQUFXLEVBQUMsQ0FBQyxDQUFDLENBQUM7UUFFakUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDO1FBRW5ELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBSTtRQUNBLE1BQU0sT0FBTyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUU7WUFDdkIsS0FBSyxFQUFFLFNBQVM7U0FDbkIsQ0FBQyxDQUFDLE1BQU0sQ0FDTCxDQUFDLENBQUMsVUFBVSxFQUFFO1lBQ1YsS0FBSyxFQUFFLGdDQUFnQztZQUN2QyxJQUFJLEVBQUUsR0FBRztZQUNULEtBQUssRUFBRSxjQUFjO1NBQ3hCLENBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFO1lBQ1YsTUFBTSxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUMzQixDQUFDLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztZQUNqQixDQUFDLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQztZQUNqQixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDNUIsQ0FBQyxDQUFDLENBQ0wsQ0FBQztRQUVGO1lBQ0ksRUFBQyxFQUFFLEVBQUUsU0FBUyxFQUFHLEtBQUssRUFBRSxJQUFJLEVBQUM7WUFDN0IsRUFBQyxFQUFFLEVBQUUsU0FBUyxFQUFHLEtBQUssRUFBRSxTQUFTLEVBQUM7WUFDbEMsRUFBQyxFQUFFLEVBQUUsU0FBUyxFQUFHLEtBQUssRUFBRSxLQUFLLEVBQUM7WUFDOUIsRUFBQyxFQUFFLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxJQUFJLEVBQUM7WUFDN0IsRUFBQyxFQUFFLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUM7U0FDdEMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDYixJQUFJLENBQUMsQ0FBQztZQUNOLFFBQVEsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUNkLEtBQUssU0FBUztvQkFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztvQkFBQyxNQUFNO2dCQUN2QyxLQUFLLFNBQVM7b0JBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7b0JBQUMsTUFBTTtnQkFDNUMsS0FBSyxTQUFTO29CQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDO29CQUFDLE1BQU07Z0JBQ3hDLEtBQUssVUFBVTtvQkFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztvQkFBQyxNQUFNO2dCQUN4QyxLQUFLLFVBQVU7b0JBQUUsQ0FBQyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7b0JBQUMsTUFBTTtnQkFDOUMsT0FBTyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyw2QkFBNkIsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDbEUsQ0FBQztZQUVELE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRTtnQkFDekIsS0FBSyxFQUFFLGdCQUFnQjtnQkFDdkIsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLO2dCQUNoQixLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7YUFDcEIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2hDLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxPQUFPLENBQUM7SUFDbkIsQ0FBQztJQUVELGNBQWM7UUFDVixNQUFNLFlBQVksR0FBYSxFQUFFLENBQUM7UUFDbEMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxFQUFFO1lBQ2xDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzdCLElBQUksR0FBRyxFQUFFLENBQUM7Z0JBQ04sTUFBTSxDQUFDLEdBQUcsSUFBSSxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQy9CLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxHQUFHLENBQUM7cUJBQzFCLEVBQUUsQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFlLEVBQUUsRUFBRTtvQkFDbkMsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO29CQUNuQixJQUFJLENBQUMsV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQzdDLENBQUMsQ0FBQztxQkFDRCxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUUsRUFBRTtvQkFDYixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQzlCLENBQUMsQ0FBQyxDQUFDO2dCQUNQLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzdCLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQy9DLENBQUM7Q0ErQkoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJCBmcm9tIFwianF1ZXJ5XCI7XG5cbmltcG9ydCBBcHAgZnJvbSAnLi9hcHAnXG5pbXBvcnQgREIgZnJvbSAnLi4vc3JjL2RiJ1xuaW1wb3J0IE9ialZpZXdNaW5pIGZyb20gJy4vb2JqLnZpZXcubWluaSdcblxuaW1wb3J0IE1lVmlldyBmcm9tIFwiLi9tZS52aWV3XCI7XG5pbXBvcnQgRnJpZW5kc1ZpZXcgZnJvbSBcIi4vRnJpZW5kcy52aWV3XCI7XG5pbXBvcnQgTmV0VmlldyBmcm9tIFwiLi9uZXQudmlldy5qc1wiO1xuaW1wb3J0IERCVmlldyBmcm9tIFwiLi9kYi52aWV3LmpzXCI7XG5pbXBvcnQgTWF0Y2hpbmdWaWV3IGZyb20gXCIuL21hdGNoLnZpZXcuanNcIjtcbmltcG9ydCAnL3VpL2Nzcy9zaWRlYmFyLmNzcyc7XG5cbmNsYXNzIFBhZ2VDb250ZXh0TWVudSB7XG4gICAgcmVhZG9ubHkgZWxlOiBKUXVlcnk7XG4gICAgcHJpdmF0ZSBkYjogREI7XG4gICAgcHJpdmF0ZSBzaWRlYmFyOiBTaWRlYmFyO1xuICAgIHByaXZhdGUgc2VsZWN0ZWRQYWdlSWQ6IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKGRiOkRCLCBhcHA6U2lkZWJhcikge1xuICAgICAgICB0aGlzLmRiID0gZGI7XG4gICAgICAgIHRoaXMuc2lkZWJhciA9IGFwcDtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFBhZ2VJZCA9IG51bGw7XG4gICAgICAgIHRoaXMuZWxlID0gJCgnPGRpdj4nKS5hZGRDbGFzcygnY29udGV4dC1tZW51JykuaHRtbChgXG4gICAgICAgICAgICA8dWw+XG4gICAgICAgICAgICAgICAgPGxpIGRhdGEtYWN0aW9uPVwicmVuYW1lLXBhZ2VcIj5SZW5hbWU8L2xpPlxuICAgICAgICAgICAgICAgIDxsaSBkYXRhLWFjdGlvbj1cImRlbGV0ZS1wYWdlXCI+RGVsZXRlPC9saT5cbiAgICAgICAgICAgIDwvdWw+XG4gICAgICAgIGApO1xuXG4gICAgICAgIC8vaGFuZGxlIGNsaWNrcyBvdXRzaWRlIHRoZSBtZW51XG4gICAgICAgIC8vICQodGhpcy5lbGUpLmNsaWNrKGUgPT4ge1xuICAgICAgICAvLyAgICAgaWYgKCF0aGlzLmVsZS5oYXMoZS50YXJnZXQpLmxlbmd0aClcbiAgICAgICAgLy8gICAgICAgICB0aGlzLmhpZGUoKTtcbiAgICAgICAgLy8gfSk7XG4gICAgICAgICQoZG9jdW1lbnQpLmNsaWNrKGUgPT4ge1xuICAgICAgICAgICAgaWYgKCEkKGUudGFyZ2V0KS5jbG9zZXN0KCcjY29udGV4dC1tZW51JykubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmVsZS5vbignY2xpY2snLCAnbGknLCBlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGFjdGlvbiA9ICQoZS50YXJnZXQpLmRhdGEoJ2FjdGlvbicpO1xuICAgICAgICAgICAgaWYgKCFhY3Rpb24pIHJldHVybjtcbiAgICAgICAgICAgIGlmIChhY3Rpb24gPT09ICdyZW5hbWUtcGFnZScpIHRoaXMucmVuYW1lUGFnZSgpO1xuICAgICAgICAgICAgZWxzZSBpZiAoYWN0aW9uID09PSAnZGVsZXRlLXBhZ2UnKSB0aGlzLmRlbGV0ZVBhZ2UoKTtcbiAgICAgICAgICAgIHRoaXMuaGlkZSgpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICByZW5hbWVQYWdlKCkge1xuICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFBhZ2VJZCkge1xuICAgICAgICAgICAgY29uc3QgbmV3TmFtZSA9IHByb21wdCgnRW50ZXIgbmV3IHBhZ2UgbmFtZTonKTtcbiAgICAgICAgICAgIGlmIChuZXdOYW1lKSB0aGlzLmRiLm9iak5hbWUodGhpcy5zZWxlY3RlZFBhZ2VJZCwgbmV3TmFtZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBkZWxldGVQYWdlKCkge1xuICAgICAgICBpZiAodGhpcy5zZWxlY3RlZFBhZ2VJZCAmJiBjb25maXJtKCdBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZGVsZXRlIHRoaXMgcGFnZT8nKSkge1xuICAgICAgICAgICAgdGhpcy5kYi5kZWxldGUodGhpcy5zZWxlY3RlZFBhZ2VJZCk7XG4gICAgICAgICAgICBpZiAodGhpcy5kYi5nZXQodGhpcy5zZWxlY3RlZFBhZ2VJZCk/LnB1YmxpYykgdGhpcy5zaWRlYmFyLmFwcC5uZXQudW5zaGFyZURvY3VtZW50KHRoaXMuc2VsZWN0ZWRQYWdlSWQpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2hvd0NvbnRleHRNZW51KGV2ZW50OkNvbnRleHRNZW51RXZlbnQsIHBhZ2VJZDpzdHJpbmcpIHtcbiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZFBhZ2VJZCA9IHBhZ2VJZDtcbiAgICAgICAgdGhpcy5lbGUuY3NzKHtcbiAgICAgICAgICAgIHRvcDogZXZlbnQuY2xpZW50WSxcbiAgICAgICAgICAgIGxlZnQ6IGV2ZW50LmNsaWVudFgsXG4gICAgICAgICAgICBkaXNwbGF5OiAnYmxvY2snXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGhpZGUoKSB7XG4gICAgICAgIHRoaXMuZWxlLmhpZGUoKTtcbiAgICB9XG59XG5cbmltcG9ydCBDb250ZXh0TWVudUV2ZW50ID0gSlF1ZXJ5LkNvbnRleHRNZW51RXZlbnQ7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFNpZGViYXIge1xuICAgIHJlYWRvbmx5IGVsZTogSlF1ZXJ5O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGI6IERCO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbWVWaWV3OiBNZVZpZXc7XG4gICAgcHJpdmF0ZSByZWFkb25seSBmcmllbmRzVmlldzogRnJpZW5kc1ZpZXc7XG4gICAgcHJpdmF0ZSByZWFkb25seSBuZXRWaWV3OiBOZXRWaWV3O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgZGJWaWV3OiBEQlZpZXc7XG4gICAgcHJpdmF0ZSByZWFkb25seSBtYXRjaGluZ1ZpZXc6IE1hdGNoaW5nVmlldztcbiAgICBwdWJsaWMgYXBwOiBBcHA7XG4gICAgcHJpdmF0ZSBjb250ZXh0TWVudTogUGFnZUNvbnRleHRNZW51O1xuICAgIHByaXZhdGUgcGFnZUxpc3Q6IEpRdWVyeTtcblxuICAgIGNvbnN0cnVjdG9yKGFwcDpBcHApIHtcbiAgICAgICAgY29uc3Qgcm9vdCA9IGFwcC5lbGU7XG5cbiAgICAgICAgdGhpcy5lbGUgPSAkKCc8ZGl2PicpLmFkZENsYXNzKCdzaWRlYmFyJyk7XG5cbiAgICAgICAgdGhpcy5hcHAgPSBhcHA7XG4gICAgICAgIHRoaXMuZGIgPSBhcHAuZGI7XG5cbiAgICAgICAgY29uc3QgdGhpc0F3YXJlID0gYXBwLmF3YXJlbmVzcy5iaW5kKGFwcCk7XG4gICAgICAgIHRoaXMubWVWaWV3ID0gbmV3IE1lVmlldyhyb290LCBhcHAudXNlci5iaW5kKGFwcCksIHRoaXNBd2FyZSk7XG4gICAgICAgIHRoaXMuZnJpZW5kc1ZpZXcgPSBuZXcgRnJpZW5kc1ZpZXcocm9vdCwgdGhpc0F3YXJlKTtcbiAgICAgICAgdGhpcy5uZXRWaWV3ID0gbmV3IE5ldFZpZXcocm9vdC5maW5kKCcubWFpbi12aWV3JyksIGFwcC5uZXQpO1xuICAgICAgICB0aGlzLmRiVmlldyA9IG5ldyBEQlZpZXcocm9vdCwgdGhpcy5kYik7XG4gICAgICAgIHRoaXMubWF0Y2hpbmdWaWV3ID0gbmV3IE1hdGNoaW5nVmlldyhyb290LCBhcHAubWF0Y2gpO1xuXG5cbiAgICAgICAgdGhpcy5lbGUuYXBwZW5kKHRoaXMubWVudSgpKTtcbiAgICAgICAgdGhpcy5jb250ZXh0TWVudSA9IG5ldyBQYWdlQ29udGV4dE1lbnUodGhpcy5kYiwgdGhpcyk7XG4gICAgICAgIHJvb3QuYXBwZW5kKHRoaXMuY29udGV4dE1lbnUuZWxlKTtcblxuICAgICAgICB0aGlzLmVsZS5hcHBlbmQodGhpcy5wYWdlTGlzdCA9ICQoJzx1bD4nLCB7Y2xhc3M6ICdwYWdlLWxpc3QnfSkpO1xuXG4gICAgICAgIHRoaXMuZGIuaW5kZXgub2JzZXJ2ZSgoKSA9PiB0aGlzLnVwZGF0ZVBhZ2VMaXN0KCkpO1xuXG4gICAgICAgIHRoaXMudXBkYXRlUGFnZUxpc3QoKTtcbiAgICB9XG5cbiAgICBtZW51KCkge1xuICAgICAgICBjb25zdCBtZW51QmFyID0gJCgnPGRpdj4nLCB7XG4gICAgICAgICAgICBjbGFzczogJ21lbnViYXInXG4gICAgICAgIH0pLmFwcGVuZChcbiAgICAgICAgICAgICQoJzxidXR0b24+Jywge1xuICAgICAgICAgICAgICAgIGNsYXNzOiAnbWVudWJhci1idXR0b24gYWRkLXBhZ2UtYnV0dG9uJyxcbiAgICAgICAgICAgICAgICB0ZXh0OiAnKycsXG4gICAgICAgICAgICAgICAgdGl0bGU6ICdBZGQgTmV3IFBhZ2UnXG4gICAgICAgICAgICB9KS5jbGljaygoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcCA9IHRoaXMuZGIuY3JlYXRlKCk7XG4gICAgICAgICAgICAgICAgcC5uYW1lID0gJ0VtcHR5JztcbiAgICAgICAgICAgICAgICBwLnB1YmxpYyA9IGZhbHNlO1xuICAgICAgICAgICAgICAgIHRoaXMuYXBwLmVkaXRvci52aWV3KHApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgKTtcblxuICAgICAgICBbXG4gICAgICAgICAgICB7aWQ6ICdwcm9maWxlJywgIHRpdGxlOiAnTWUnfSxcbiAgICAgICAgICAgIHtpZDogJ2ZyaWVuZHMnLCAgdGl0bGU6ICdGcmllbmRzJ30sXG4gICAgICAgICAgICB7aWQ6ICduZXR3b3JrJywgIHRpdGxlOiAnTmV0J30sXG4gICAgICAgICAgICB7aWQ6ICdkYXRhYmFzZScsIHRpdGxlOiAnREInfSxcbiAgICAgICAgICAgIHtpZDogJ21hdGNoaW5nJywgdGl0bGU6ICdNYXRjaGluZyd9LFxuICAgICAgICBdLmZvckVhY2godmlldyA9PiB7XG4gICAgICAgICAgICBsZXQgdjtcbiAgICAgICAgICAgIHN3aXRjaCAodmlldy5pZCkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ3Byb2ZpbGUnOiB2ID0gdGhpcy5tZVZpZXc7IGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ2ZyaWVuZHMnOiB2ID0gdGhpcy5mcmllbmRzVmlldzsgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSAnbmV0d29yayc6IHYgPSB0aGlzLm5ldFZpZXc7IGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgJ2RhdGFiYXNlJzogdiA9IHRoaXMuZGJWaWV3OyBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICdtYXRjaGluZyc6IHYgPSB0aGlzLm1hdGNoaW5nVmlldzsgYnJlYWs7XG4gICAgICAgICAgICAgICAgZGVmYXVsdDogY29uc29sZS53YXJuKGBObyBwYWdlIGNsYXNzIGRlZmluZWQgZm9yICR7dmlldy5pZH1gKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgbWVudUJhci5hcHBlbmQoJCgnPGJ1dHRvbj4nLCB7XG4gICAgICAgICAgICAgICAgY2xhc3M6ICdtZW51YmFyLWJ1dHRvbicsXG4gICAgICAgICAgICAgICAgdGV4dDogdmlldy50aXRsZSxcbiAgICAgICAgICAgICAgICB0aXRsZTogdmlldy50aXRsZVxuICAgICAgICAgICAgfSkuY2xpY2soKCkgPT4gdi5yZW5kZXIoKSkpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbWVudUJhcjtcbiAgICB9XG5cbiAgICB1cGRhdGVQYWdlTGlzdCgpIHtcbiAgICAgICAgY29uc3QgbmV4dFBhZ2VMaXN0OiBKUXVlcnlbXSA9IFtdO1xuICAgICAgICB0aGlzLmRiLmluZGV4LmZvckVhY2goKF92YWx1ZSwga2V5KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvYmogPSB0aGlzLmRiLmdldChrZXkpO1xuICAgICAgICAgICAgaWYgKG9iaikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHYgPSBuZXcgT2JqVmlld01pbmkob2JqKTtcbiAgICAgICAgICAgICAgICB2LmVsZS5hdHRyKCdkYXRhLXBhZ2UtaWQnLCBrZXkpXG4gICAgICAgICAgICAgICAgICAgIC5vbignY29udGV4dG1lbnUnLCAoZTogSlF1ZXJ5LkV2ZW50KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbnRleHRNZW51LnNob3dDb250ZXh0TWVudShlLCBrZXkpO1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAub24oJ2NsaWNrJywgKCk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwLmVkaXRvci52aWV3KG9iaik7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIG5leHRQYWdlTGlzdC5wdXNoKHYuZWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMucGFnZUxpc3QuZW1wdHkoKS5hcHBlbmQobmV4dFBhZ2VMaXN0KTtcbiAgICB9XG5cbiAgICAvLyB1cGRhdGVQYWdlTGlzdCgpIHtcbiAgICAvLyAgICAgY29uc3QgbmV4dFBhZ2VMaXN0OkpRdWVyeVtdID0gW107XG4gICAgLy8gICAgIHRoaXMuZGIuaW5kZXguZm9yRWFjaCgoX3ZhbHVlLCBrZXkpID0+IHtcbiAgICAvL1xuICAgIC8vICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmRiLmdldChrZXkpO1xuICAgIC8vICAgICAgICAgbGV0IG5hbWUgPSB2YWx1ZS5uYW1lO1xuICAgIC8vICAgICAgICAgY29uc3QgbGkgPSAkKCc8bGk+Jywge1xuICAgIC8vICAgICAgICAgICAgIHRleHQ6IG5hbWUsXG4gICAgLy8gICAgICAgICAgICAgJ2RhdGEtcGFnZS1pZCc6IGtleSxcbiAgICAvLyAgICAgICAgICAgICB0aXRsZTogYE9wZW4gJHtuYW1lfWAsXG4gICAgLy8gICAgICAgICAgICAgY2xhc3M6ICd1c2VyLXBhZ2UtaXRlbSdcbiAgICAvLyAgICAgICAgIH0pO1xuICAgIC8vXG4gICAgLy8gICAgICAgICBpZiAodmFsdWUucHVibGljKVxuICAgIC8vICAgICAgICAgICAgIGxpLmFwcGVuZCgkKCc8c3Bhbj4nLCB7dGV4dDogJyDwn4yQJywgIHRpdGxlOiAnUHVibGljIERvY3VtZW50J30pKTtcbiAgICAvL1xuICAgIC8vICAgICAgICAgbGkub24oe1xuICAgIC8vICAgICAgICAgICAgIGNsaWNrOiAoKSA9PiB0aGlzLmFwcC5lZGl0b3Iudmlldyh0aGlzLmRiLmdldChrZXkpKSxcbiAgICAvLyAgICAgICAgICAgICBjb250ZXh0bWVudTogZSA9PiB7XG4gICAgLy8gICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAvLyAgICAgICAgICAgICAgICAgdGhpcy5jb250ZXh0TWVudS5zaG93Q29udGV4dE1lbnUoZSwga2V5KTtcbiAgICAvLyAgICAgICAgICAgICB9LFxuICAgIC8vICAgICAgICAgICAgIGRibGNsaWNrOiAoKSA9PiB7IH1cbiAgICAvLyAgICAgICAgIH0pO1xuICAgIC8vXG4gICAgLy8gICAgICAgICBuZXh0UGFnZUxpc3QucHVzaChsaSk7XG4gICAgLy8gICAgIH0pO1xuICAgIC8vICAgICB0aGlzLnBhZ2VMaXN0LmVtcHR5KCkuYXBwZW5kKG5leHRQYWdlTGlzdCk7XG4gICAgLy8gfVxufVxuIl19