import express from 'express';
import http from 'http';
import path from 'path';
import { Server as SocketIOServer } from 'socket.io';
import { createServer as viteServer } from 'vite';
import { Tool, OCRTool, VisionLLMTool, TextLLMTool } from './aissist/tools'; // Import tools
import { SnapshotManager } from './aissist/snapshotter';
const PORT = 3000;
//////////////////////////////
// Utils
//////////////////////////////
const Utils = {
    delay: ms => new Promise(r => setTimeout(r, ms)),
    getEnvNumber: (key, def) => isNaN(parseInt(process.env[key])) ? def : parseInt(process.env[key]),
    getEnvString: (key, def) => process.env[key] || def,
};
//////////////////////////////
// Plugin Management
//////////////////////////////
const activePlugins = {};
async function loadPlugin(pluginName) {
    switch (pluginName) {
        case 'ocr': return new OCRTool();
        case 'vision': return new VisionLLMTool(Utils.getEnvString('VISION_OLLAMA_URL', 'http://localhost:11434/api/chat'), Utils.getEnvString('VISION_MODEL', 'llava:7b'));
        case 'summary': return new TextLLMTool(Utils.getEnvString('NON_VISION_OLLAMA_URL', 'http://localhost:11434/api/chat'), Utils.getEnvString('NON_VISION_MODEL', 'llava:7b'));
        default: throw new Error(`Unknown plugin: ${pluginName}`);
    }
}
async function togglePlugin(pluginName, enable) {
    if (enable) {
        if (!activePlugins[pluginName])
            activePlugins[pluginName] = await loadPlugin(pluginName);
    }
    else {
        delete activePlugins[pluginName]; // Stop and remove the plugin
    }
    io.emit('plugin-status', activePlugins); // Broadcast status update
}
const PORT = 3000;
(async () => {
    const app = express();
    app.use((await viteServer({
        server: { middlewareMode: 'html' },
        root: path.resolve('../'),
    })).middlewares);
    const httpServer = http.createServer(app);
    const io = new SocketIOServer(httpServer, {
        cors: { origin: '*' },
    });
    // const appConfig = { }
    // const plugins: { [pluginName: string]: Plugin } = {};
    // for (const pluginName in appConfig.plugins) {
    //     if (appConfig.plugins[pluginName].enabled) {
    //         const plugin = await loadPlugin(pluginName);
    //         plugins[pluginName] = plugin;
    //         await plugin.init(io, appConfig.plugins[pluginName]);
    //         await plugin.start();
    //     }
    // }
    function wsConnect(s) {
        console.log('User connected:', s.id);
        s.on('signal', (message) => {
            const { target, data } = message;
            console.log(`Relaying message from ${s.id} to ${target}`);
            io.to(target).emit('signal', { sender: s.id, data });
        });
        s.on('join', (roomId) => {
            s.join(roomId);
            console.log(`${s.id} joined room: ${roomId}`);
            s.to(roomId).emit('user-joined', { userId: s.id });
        });
        s.on('join', (roomId) => {
            s.join(roomId);
            console.log(`${s.id} joined room: ${roomId}`);
            s.to(roomId).emit('user-joined', { userId: s.id });
        });
        s.on('toggle-plugin', async (pluginName, enable) => {
            try {
                await togglePlugin(pluginName, enable);
            }
            catch (e) {
                console.error(`Failed to toggle plugin ${pluginName}:`, e);
                s.emit('plugin-error', pluginName, e.message);
            }
        });
        s.on('disconnect', () => {
            console.log('User disconnected:', s.id);
        });
        // // Generic plugin message handler
        // s.on('plugin-message', async (pluginName, topic, message) => {
        //     if (plugins[pluginName] && plugins[pluginName].handleMessage) {
        //         await plugins[pluginName].handleMessage(topic, message);
        //     }
        // });
    }
    io.on('connection', (socket) => wsConnect(socket));
    // Define HTTP routes
    app.get('/status', (req, res) => {
        res.json({ status: 'OK', timestamp: new Date() });
    });
    // Snapshot manager
    const snapshotManager = new SnapshotManager();
    // Start analysis loop
    const analysisInterval = Utils.getEnvNumber('ANALYSIS_INTERVAL', 10000);
    setInterval(async () => {
        const snap = await snapshotManager.createSnapshot();
        for (const pluginName in activePlugins) {
            const plugin = activePlugins[pluginName];
            if (plugin.canRun(snap)) {
                try {
                    await plugin.run(snap);
                }
                catch (e) {
                    console.error(`Plugin ${pluginName} error:`, e);
                }
            }
        }
        io.emit('snapshot', snap); // Broadcast snapshot data
    }, analysisInterval);
    httpServer.listen(PORT, () => {
        console.log(`Signaling server is running at http://localhost:${PORT}`);
    });
})();
//////////////////////////////
// Aissist tools (moved from renderer.js)
//////////////////////////////
// ... (Tool, OCRTool, VisionLLMTool, TextLLMTool, SnapshotManager code from renderer.js)
// ... but remove the ipcRenderer parts and the UI update functions (updateStatus, updateData, displayNotification)
// ... and export the classes:
export { Tool, OCRTool, VisionLLMTool, TextLLMTool };
export { SnapshotManager };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm9kZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm5vZGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxPQUFPLE1BQU0sU0FBUyxDQUFDO0FBQzlCLE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQztBQUN4QixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxFQUFFLE1BQU0sSUFBSSxjQUFjLEVBQVUsTUFBTSxXQUFXLENBQUM7QUFDN0QsT0FBTyxFQUFFLFlBQVksSUFBSSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFDLElBQUksRUFBRSxPQUFPLEVBQUUsYUFBYSxFQUFFLFdBQVcsRUFBQyxNQUFNLGlCQUFpQixDQUFDLENBQUMsZUFBZTtBQUMxRixPQUFPLEVBQUMsZUFBZSxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFFdEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO0FBRWxCLDhCQUE4QjtBQUM5QixRQUFRO0FBQ1IsOEJBQThCO0FBQzlCLE1BQU0sS0FBSyxHQUFHO0lBQ1YsS0FBSyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ2hELFlBQVksRUFBRSxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEcsWUFBWSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFHO0NBQ3RELENBQUM7QUFF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Q0FBQztvQkFDRCxNQUFNLE1BQU0sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzNCLENBQUM7Z0JBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztvQkFDVCxPQUFPLENBQUMsS0FBSyxDQUFDLFVBQVUsVUFBVSxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3BELENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQztRQUNELEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsMEJBQTBCO0lBQ3pELENBQUMsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0lBRXJCLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRTtRQUN6QixPQUFPLENBQUMsR0FBRyxDQUFDLG1EQUFtRCxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQzNFLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLEVBQUUsQ0FBQztBQUdMLDhCQUE4QjtBQUM5Qix5Q0FBeUM7QUFDekMsOEJBQThCO0FBQzlCLHlGQUF5RjtBQUN6RixtSEFBbUg7QUFDbkgsOEJBQThCO0FBQzlCLE9BQU8sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLGFBQWEsRUFBRSxXQUFXLEVBQUUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZUFBZSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZXhwcmVzcyBmcm9tICdleHByZXNzJztcbmltcG9ydCBodHRwIGZyb20gJ2h0dHAnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBTZXJ2ZXIgYXMgU29ja2V0SU9TZXJ2ZXIsIFNvY2tldCB9IGZyb20gJ3NvY2tldC5pbyc7XG5pbXBvcnQgeyBjcmVhdGVTZXJ2ZXIgYXMgdml0ZVNlcnZlciB9IGZyb20gJ3ZpdGUnO1xuaW1wb3J0IHtUb29sLCBPQ1JUb29sLCBWaXNpb25MTE1Ub29sLCBUZXh0TExNVG9vbH0gZnJvbSAnLi9haXNzaXN0L3Rvb2xzJzsgLy8gSW1wb3J0IHRvb2xzXG5pbXBvcnQge1NuYXBzaG90TWFuYWdlcn0gZnJvbSAnLi9haXNzaXN0L3NuYXBzaG90dGVyJztcblxuY29uc3QgUE9SVCA9IDMwMDA7XG5cbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy8gVXRpbHNcbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuY29uc3QgVXRpbHMgPSB7XG4gICAgZGVsYXk6IG1zID0+IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtcykpLFxuICAgIGdldEVudk51bWJlcjogKGtleSwgZGVmKSA9PiBpc05hTihwYXJzZUludChwcm9jZXNzLmVudltrZXldKSkgPyBkZWYgOiBwYXJzZUludChwcm9jZXNzLmVudltrZXldKSxcbiAgICBnZXRFbnZTdHJpbmc6IChrZXksIGRlZikgPT4gcHJvY2Vzcy5lbnZba2V5XSB8fCBkZWYsXG59O1xuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIFBsdWdpbiBNYW5hZ2VtZW50XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbmNvbnN0IGFjdGl2ZVBsdWdpbnMgPSB7fTtcblxuYXN5bmMgZnVuY3Rpb24gbG9hZFBsdWdpbihwbHVnaW5OYW1lKSB7XG4gICAgc3dpdGNoIChwbHVnaW5OYW1lKSB7XG4gICAgICAgIGNhc2UgJ29jcic6IHJldHVybiBuZXcgT0NSVG9vbCgpO1xuICAgICAgICBjYXNlICd2aXNpb24nOiByZXR1cm4gbmV3IFZpc2lvbkxMTVRvb2woVXRpbHMuZ2V0RW52U3RyaW5nKCdWSVNJT05fT0xMQU1BX1VSTCcsJ2h0dHA6Ly9sb2NhbGhvc3Q6MTE0MzQvYXBpL2NoYXQnKSwgVXRpbHMuZ2V0RW52U3RyaW5nKCdWSVNJT05fTU9ERUwnLCdsbGF2YTo3YicpKTtcbiAgICAgICAgY2FzZSAnc3VtbWFyeSc6IHJldHVybiBuZXcgVGV4dExMTVRvb2woVXRpbHMuZ2V0RW52U3RyaW5nKCdOT05fVklTSU9OX09MTEFNQV9VUkwnLCdodHRwOi8vbG9jYWxob3N0OjExNDM0L2FwaS9jaGF0JyksIFV0aWxzLmdldEVudlN0cmluZygnTk9OX1ZJU0lPTl9NT0RFTCcsJ2xsYXZhOjdiJykpO1xuICAgICAgICBkZWZhdWx0OiB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gcGx1Z2luOiAke3BsdWdpbk5hbWV9YCk7XG4gICAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiB0b2dnbGVQbHVnaW4ocGx1Z2luTmFtZSwgZW5hYmxlKSB7XG4gICAgaWYgKGVuYWJsZSkge1xuICAgICAgICBpZiAoIWFjdGl2ZVBsdWdpbnNbcGx1Z2luTmFtZV0pIGFjdGl2ZVBsdWdpbnNbcGx1Z2luTmFtZV0gPSBhd2FpdCBsb2FkUGx1Z2luKHBsdWdpbk5hbWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICAgIGRlbGV0ZSBhY3RpdmVQbHVnaW5zW3BsdWdpbk5hbWVdOyAvLyBTdG9wIGFuZCByZW1vdmUgdGhlIHBsdWdpblxuICAgIH1cbiAgICBpby5lbWl0KCdwbHVnaW4tc3RhdHVzJywgYWN0aXZlUGx1Z2lucyk7IC8vIEJyb2FkY2FzdCBzdGF0dXMgdXBkYXRlXG59XG5cbmNvbnN0IFBPUlQgPSAzMDAwO1xuXG4oYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IGFwcCA9IGV4cHJlc3MoKTtcblxuICAgIGFwcC51c2UoKGF3YWl0IHZpdGVTZXJ2ZXIoe1xuICAgICAgICBzZXJ2ZXI6IHsgbWlkZGxld2FyZU1vZGU6ICdodG1sJyB9LFxuICAgICAgICByb290OiBwYXRoLnJlc29sdmUoJy4uLycpLFxuICAgIH0pKS5taWRkbGV3YXJlcyk7XG5cbiAgICBjb25zdCBodHRwU2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKTtcblxuICAgIGNvbnN0IGlvID0gbmV3IFNvY2tldElPU2VydmVyKGh0dHBTZXJ2ZXIsIHtcbiAgICAgICAgY29yczogeyBvcmlnaW46ICcqJyB9LFxuICAgIH0pO1xuXG5cbiAgICAvLyBjb25zdCBhcHBDb25maWcgPSB7IH1cbiAgICAvLyBjb25zdCBwbHVnaW5zOiB7IFtwbHVnaW5OYW1lOiBzdHJpbmddOiBQbHVnaW4gfSA9IHt9O1xuICAgIC8vIGZvciAoY29uc3QgcGx1Z2luTmFtZSBpbiBhcHBDb25maWcucGx1Z2lucykge1xuICAgIC8vICAgICBpZiAoYXBwQ29uZmlnLnBsdWdpbnNbcGx1Z2luTmFtZV0uZW5hYmxlZCkge1xuICAgIC8vICAgICAgICAgY29uc3QgcGx1Z2luID0gYXdhaXQgbG9hZFBsdWdpbihwbHVnaW5OYW1lKTtcbiAgICAvLyAgICAgICAgIHBsdWdpbnNbcGx1Z2luTmFtZV0gPSBwbHVnaW47XG4gICAgLy8gICAgICAgICBhd2FpdCBwbHVnaW4uaW5pdChpbywgYXBwQ29uZmlnLnBsdWdpbnNbcGx1Z2luTmFtZV0pO1xuICAgIC8vICAgICAgICAgYXdhaXQgcGx1Z2luLnN0YXJ0KCk7XG4gICAgLy8gICAgIH1cbiAgICAvLyB9XG5cbiAgICBmdW5jdGlvbiB3c0Nvbm5lY3QoczogU29ja2V0KSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdVc2VyIGNvbm5lY3RlZDonLCBzLmlkKTtcblxuICAgICAgICBzLm9uKCdzaWduYWwnLCAobWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyB0YXJnZXQsIGRhdGEgfSA9IG1lc3NhZ2U7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgUmVsYXlpbmcgbWVzc2FnZSBmcm9tICR7cy5pZH0gdG8gJHt0YXJnZXR9YCk7XG4gICAgICAgICAgICBpby50byh0YXJnZXQpLmVtaXQoJ3NpZ25hbCcsIHsgc2VuZGVyOiBzLmlkLCBkYXRhIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICBzLm9uKCdqb2luJywgKHJvb21JZCkgPT4ge1xuICAgICAgICAgICAgcy5qb2luKHJvb21JZCk7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtzLmlkfSBqb2luZWQgcm9vbTogJHtyb29tSWR9YCk7XG4gICAgICAgICAgICBzLnRvKHJvb21JZCkuZW1pdCgndXNlci1qb2luZWQnLCB7IHVzZXJJZDogcy5pZCB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcy5vbignam9pbicsIChyb29tSWQpID0+IHtcbiAgICAgICAgICAgIHMuam9pbihyb29tSWQpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYCR7cy5pZH0gam9pbmVkIHJvb206ICR7cm9vbUlkfWApO1xuICAgICAgICAgICAgcy50byhyb29tSWQpLmVtaXQoJ3VzZXItam9pbmVkJywgeyB1c2VySWQ6IHMuaWQgfSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHMub24oJ3RvZ2dsZS1wbHVnaW4nLCBhc3luYyAocGx1Z2luTmFtZSwgZW5hYmxlKSA9PiB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRvZ2dsZVBsdWdpbihwbHVnaW5OYW1lLCBlbmFibGUpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byB0b2dnbGUgcGx1Z2luICR7cGx1Z2luTmFtZX06YCwgZSk7XG4gICAgICAgICAgICAgICAgcy5lbWl0KCdwbHVnaW4tZXJyb3InLCBwbHVnaW5OYW1lLCBlLm1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBzLm9uKCdkaXNjb25uZWN0JywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ1VzZXIgZGlzY29ubmVjdGVkOicsIHMuaWQpO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyAvLyBHZW5lcmljIHBsdWdpbiBtZXNzYWdlIGhhbmRsZXJcbiAgICAgICAgLy8gcy5vbigncGx1Z2luLW1lc3NhZ2UnLCBhc3luYyAocGx1Z2luTmFtZSwgdG9waWMsIG1lc3NhZ2UpID0+IHtcbiAgICAgICAgLy8gICAgIGlmIChwbHVnaW5zW3BsdWdpbk5hbWVdICYmIHBsdWdpbnNbcGx1Z2luTmFtZV0uaGFuZGxlTWVzc2FnZSkge1xuICAgICAgICAvLyAgICAgICAgIGF3YWl0IHBsdWdpbnNbcGx1Z2luTmFtZV0uaGFuZGxlTWVzc2FnZSh0b3BpYywgbWVzc2FnZSk7XG4gICAgICAgIC8vICAgICB9XG4gICAgICAgIC8vIH0pO1xuICAgIH1cblxuICAgIGlvLm9uKCdjb25uZWN0aW9uJywgKHNvY2tldCkgPT4gd3NDb25uZWN0KHNvY2tldCkpO1xuXG5cbiAgICAvLyBEZWZpbmUgSFRUUCByb3V0ZXNcbiAgICBhcHAuZ2V0KCcvc3RhdHVzJywgKHJlcSwgcmVzKSA9PiB7XG4gICAgICAgIHJlcy5qc29uKHsgc3RhdHVzOiAnT0snLCB0aW1lc3RhbXA6IG5ldyBEYXRlKCkgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBTbmFwc2hvdCBtYW5hZ2VyXG4gICAgY29uc3Qgc25hcHNob3RNYW5hZ2VyID0gbmV3IFNuYXBzaG90TWFuYWdlcigpO1xuXG4gICAgLy8gU3RhcnQgYW5hbHlzaXMgbG9vcFxuICAgIGNvbnN0IGFuYWx5c2lzSW50ZXJ2YWwgPSBVdGlscy5nZXRFbnZOdW1iZXIoJ0FOQUxZU0lTX0lOVEVSVkFMJywgMTAwMDApO1xuICAgIHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3Qgc25hcCA9IGF3YWl0IHNuYXBzaG90TWFuYWdlci5jcmVhdGVTbmFwc2hvdCgpO1xuICAgICAgICBmb3IgKGNvbnN0IHBsdWdpbk5hbWUgaW4gYWN0aXZlUGx1Z2lucykge1xuICAgICAgICAgICAgY29uc3QgcGx1Z2luID0gYWN0aXZlUGx1Z2luc1twbHVnaW5OYW1lXTtcbiAgICAgICAgICAgIGlmIChwbHVnaW4uY2FuUnVuKHNuYXApKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgcGx1Z2luLnJ1bihzbmFwKTtcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYFBsdWdpbiAke3BsdWdpbk5hbWV9IGVycm9yOmAsIGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpby5lbWl0KCdzbmFwc2hvdCcsIHNuYXApOyAvLyBCcm9hZGNhc3Qgc25hcHNob3QgZGF0YVxuICAgIH0sIGFuYWx5c2lzSW50ZXJ2YWwpO1xuXG4gICAgaHR0cFNlcnZlci5saXN0ZW4oUE9SVCwgKCkgPT4ge1xuICAgICAgICBjb25zb2xlLmxvZyhgU2lnbmFsaW5nIHNlcnZlciBpcyBydW5uaW5nIGF0IGh0dHA6Ly9sb2NhbGhvc3Q6JHtQT1JUfWApO1xuICAgIH0pO1xufSkoKTtcblxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIEFpc3Npc3QgdG9vbHMgKG1vdmVkIGZyb20gcmVuZGVyZXIuanMpXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vIC4uLiAoVG9vbCwgT0NSVG9vbCwgVmlzaW9uTExNVG9vbCwgVGV4dExMTVRvb2wsIFNuYXBzaG90TWFuYWdlciBjb2RlIGZyb20gcmVuZGVyZXIuanMpXG4vLyAuLi4gYnV0IHJlbW92ZSB0aGUgaXBjUmVuZGVyZXIgcGFydHMgYW5kIHRoZSBVSSB1cGRhdGUgZnVuY3Rpb25zICh1cGRhdGVTdGF0dXMsIHVwZGF0ZURhdGEsIGRpc3BsYXlOb3RpZmljYXRpb24pXG4vLyAuLi4gYW5kIGV4cG9ydCB0aGUgY2xhc3NlczpcbmV4cG9ydCB7IFRvb2wsIE9DUlRvb2wsIFZpc2lvbkxMTVRvb2wsIFRleHRMTE1Ub29sIH07XG5leHBvcnQgeyBTbmFwc2hvdE1hbmFnZXIgfTtcblxuXG4iXX0=