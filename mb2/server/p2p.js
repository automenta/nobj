import { createLibp2p } from 'libp2p';
import { bootstrap } from '@libp2p/bootstrap';
import { kadDHT } from '@libp2p/kad-dht';
import { webRTCStar } from '@libp2p/webrtc-star';
import { GossipSub } from '@chainsafe/libp2p-gossipsub';
import { MainlineDHT } from 'bittorrent-dht';
import { EventEmitter } from 'events';
import { noise } from '@chainsafe/libp2p-noise';
import { mplex } from '@libp2p/mplex';
import { logger } from 'libp2p'; //TODO ComponentLogger??
class P2PNode extends EventEmitter {
    node;
    dht;
    constructor(options) {
        super();
        this.node = this.createLibp2pNode(options);
        this.dht = new MainlineDHT();
    }
    createLibp2pNode(options) {
        const bs = options.bootstrapList || [
            "/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p-webrtc-star/",
            "/dns4/bootstrap.libp2p.io/tcp/443/wss/p2p-webrtc-star/"
        ];
        return createLibp2p({
            peerId: options.peerId,
            addresses: {
                listen: [
                    '/dns4/localhost/tcp/0/ws',
                ]
            },
            transports: [
                new webRTCStar()
            ],
            connectionEncryption: [
                new noise()
            ],
            streamMuxers: [
                new mplex()
            ],
            peerDiscovery: [
                new bootstrap({ list: bs })
            ],
            dht: new kadDHT(),
            pubsub: new GossipSub({
                logger: logger
            }),
        });
    }
    async start() {
        await this.node.start();
        this.setupEventListeners();
        this.dht.listen(6881, () => console.log('Mainline DHT listening on port 6881'));
    }
    async stop() {
        await this.node.stop();
        this.dht.destroy();
    }
    setupEventListeners() {
        this.node.connectionManager.addEventListener('peer:connect', e => {
            const connection = e.detail;
            console.log('Connected to:', connection.remotePeer.toString());
            this.emit('peer:connect', connection);
        });
        this.node.pubsub.addEventListener('message', e => {
            const msg = e.detail;
            console.log('Received message:', msg.data.toString());
            this.emit('message', msg);
        });
        this.dht.on('peer', peer => {
            console.log('Found peer:', peer);
            this.emit('dht:peer', peer);
        });
    }
    async sendGossipMessage(topic, message) {
        await this.node.pubsub.publish(topic, Buffer.from(message));
    }
    async getPeers() {
        return this.node.peerStore.getPeers();
    }
    async findNode(id) {
        return new Promise((resolve, reject) => {
            this.dht.lookup(id, (err, res) => {
                if (err)
                    reject(err);
                resolve(res);
            });
        });
    }
}
export default P2PNode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicDJwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicDJwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxRQUFRLENBQUM7QUFDdEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBRXhELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUNoRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBR3RDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxRQUFRLENBQUMsQ0FBQyx3QkFBd0I7QUFPekQsTUFBTSxPQUFRLFNBQVEsWUFBWTtJQUN0QixJQUFJLENBQU87SUFDWCxHQUFHLENBQU07SUFFakIsWUFBWSxPQUF1QjtRQUMvQixLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzNDLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxXQUFXLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsT0FBdUI7UUFDNUMsTUFBTSxFQUFFLEdBQUcsT0FBTyxDQUFDLGFBQWEsSUFBSTtZQUNoQyx3REFBd0Q7WUFDeEQsd0RBQXdEO1NBQzNELENBQUM7UUFFRixPQUFPLFlBQVksQ0FBQztZQUNoQixNQUFNLEVBQUUsT0FBTyxDQUFDLE1BQU07WUFDdEIsU0FBUyxF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LEdBQUcsRUFBRSxHQUFHLEVBQUUsRUFBRTtnQkFDN0IsSUFBSSxHQUFHO29CQUFFLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDckIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2pCLENBQUMsQ0FBQyxDQUFDO1FBQ1AsQ0FBQyxDQUFDLENBQUM7SUFDSCxDQUFDO0NBQ0o7QUFFTCxlQUFlLE9BQU8sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUxpYnAycCB9IGZyb20gJ2xpYnAycCc7XG5pbXBvcnQgeyBib290c3RyYXAgfSBmcm9tICdAbGlicDJwL2Jvb3RzdHJhcCc7XG5pbXBvcnQgeyBrYWRESFQgfSBmcm9tICdAbGlicDJwL2thZC1kaHQnO1xuaW1wb3J0IHsgd2ViUlRDU3RhciB9IGZyb20gJ0BsaWJwMnAvd2VicnRjLXN0YXInO1xuaW1wb3J0IHsgR29zc2lwU3ViIH0gZnJvbSAnQGNoYWluc2FmZS9saWJwMnAtZ29zc2lwc3ViJztcbmltcG9ydCB7IG11bHRpYWRkciB9IGZyb20gJ211bHRpYWRkcic7XG5pbXBvcnQgeyBNYWlubGluZURIVCB9IGZyb20gJ2JpdHRvcnJlbnQtZGh0JztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBub2lzZSB9IGZyb20gJ0BjaGFpbnNhZmUvbGlicDJwLW5vaXNlJztcbmltcG9ydCB7IG1wbGV4IH0gZnJvbSAnQGxpYnAycC9tcGxleCc7XG5pbXBvcnQgeyBQZWVySWQgfSBmcm9tICdAbGlicDJwL2ludGVyZmFjZS1wZWVyLWlkJztcblxuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnbGlicDJwJzsgLy9UT0RPIENvbXBvbmVudExvZ2dlcj8/XG5cbmludGVyZmFjZSBQMlBOb2RlT3B0aW9ucyB7XG4gICAgcGVlcklkOiBQZWVySWQ7XG4gICAgYm9vdHN0cmFwTGlzdD86IHN0cmluZ1tdO1xufVxuXG5jbGFzcyBQMlBOb2RlIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgICBwcml2YXRlIG5vZGU6IE5vZGU7XG4gICAgcHJpdmF0ZSBkaHQ6IGFueTtcblxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFAyUE5vZGVPcHRpb25zKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMubm9kZSA9IHRoaXMuY3JlYXRlTGlicDJwTm9kZShvcHRpb25zKTtcbiAgICAgICAgdGhpcy5kaHQgPSBuZXcgTWFpbmxpbmVESFQoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZUxpYnAycE5vZGUob3B0aW9uczogUDJQTm9kZU9wdGlvbnMpOiBOb2RlIHtcbiAgICAgICAgY29uc3QgYnMgPSBvcHRpb25zLmJvb3RzdHJhcExpc3QgfHwgW1xuICAgICAgICAgICAgXCIvZG5zNC9ib290c3RyYXAubGlicDJwLmlvL3RjcC80NDMvd3NzL3AycC13ZWJydGMtc3Rhci9cIixcbiAgICAgICAgICAgIFwiL2RuczQvYm9vdHN0cmFwLmxpYnAycC5pby90Y3AvNDQzL3dzcy9wMnAtd2VicnRjLXN0YXIvXCJcbiAgICAgICAgXTtcblxuICAgICAgICByZXR1cm4gY3JlYXRlTGlicDJwKHtcbiAgICAgICAgICAgIHBlZXJJZDogb3B0aW9ucy5wZWVySWQsXG4gICAgICAgICAgICBhZGRyZXNzZXM6IHtcbiAgICAgICAgICAgICAgICBsaXN0ZW46IFtcbiAgICAgICAgICAgICAgICAgICAgJy9kbnM0L2xvY2FsaG9zdC90Y3AvMC93cycsXG4gICAgICAgICAgICAgICAgXVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRyYW5zcG9ydHM6IFtcbiAgICAgICAgICAgICAgICBuZXcgd2ViUlRDU3RhcigpXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgY29ubmVjdGlvbkVuY3J5cHRpb246IFtcbiAgICAgICAgICAgICAgICBuZXcgbm9pc2UoKVxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIHN0cmVhbU11eGVyczogW1xuICAgICAgICAgICAgICAgIG5ldyBtcGxleCgpXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcGVlckRpc2NvdmVyeTogW1xuICAgICAgICAgICAgICAgIG5ldyBib290c3RyYXAoeyBsaXN0OiBicyB9KVxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIGRodDogbmV3IGthZERIVCgpLFxuICAgICAgICAgICAgcHVic3ViOiBuZXcgR29zc2lwU3ViKHtcbiAgICAgICAgICAgICAgICBsb2dnZXI6IGxvZ2dlclxuICAgICAgICAgICAgfSksXG4gICAgICAgIH0pO1xuICAgICAgICB9XG5cbiAgICBhc3luYyBzdGFydCgpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5ub2RlLnN0YXJ0KCk7XG4gICAgICAgIHRoaXMuc2V0dXBFdmVudExpc3RlbmVycygpO1xuICAgICAgICB0aGlzLmRodC5saXN0ZW4oNjg4MSwgKCkgPT4gY29uc29sZS5sb2coJ01haW5saW5lIERIVCBsaXN0ZW5pbmcgb24gcG9ydCA2ODgxJykpO1xuICAgIH1cblxuICAgIGFzeW5jIHN0b3AoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMubm9kZS5zdG9wKCk7XG4gICAgICAgIHRoaXMuZGh0LmRlc3Ryb3koKTtcbiAgICAgICAgfVxuXG4gICAgcHJpdmF0ZSBzZXR1cEV2ZW50TGlzdGVuZXJzKCkge1xuICAgICAgICB0aGlzLm5vZGUuY29ubmVjdGlvbk1hbmFnZXIuYWRkRXZlbnRMaXN0ZW5lcigncGVlcjpjb25uZWN0JywgZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb25uZWN0aW9uID0gZS5kZXRhaWw7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnQ29ubmVjdGVkIHRvOicsIGNvbm5lY3Rpb24ucmVtb3RlUGVlci50b1N0cmluZygpKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgncGVlcjpjb25uZWN0JywgY29ubmVjdGlvbik7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMubm9kZS5wdWJzdWIuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgbXNnID0gZS5kZXRhaWw7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnUmVjZWl2ZWQgbWVzc2FnZTonLCBtc2cuZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnbWVzc2FnZScsIG1zZyk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZGh0Lm9uKCdwZWVyJywgcGVlciA9PiB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnRm91bmQgcGVlcjonLCBwZWVyKTtcbiAgICAgICAgICAgIHRoaXMuZW1pdCgnZGh0OnBlZXInLCBwZWVyKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgYXN5bmMgc2VuZEdvc3NpcE1lc3NhZ2UodG9waWM6IHN0cmluZywgbWVzc2FnZTogc3RyaW5nKSB7XG4gICAgICAgIGF3YWl0IHRoaXMubm9kZS5wdWJzdWIucHVibGlzaCh0b3BpYywgQnVmZmVyLmZyb20obWVzc2FnZSkpO1xuICAgICAgICB9XG5cbiAgICBhc3luYyBnZXRQZWVycygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubm9kZS5wZWVyU3RvcmUuZ2V0UGVlcnMoKTtcbiAgICB9XG5cbiAgICBhc3luYyBmaW5kTm9kZShpZDogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLmRodC5sb29rdXAoaWQsIChlcnIsIHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpO1xuICAgICAgICAgICAgICAgIHJlc29sdmUocmVzKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuZXhwb3J0IGRlZmF1bHQgUDJQTm9kZTtcbiJdfQ==