// src/db.ts
import * as Y from 'yjs';
import { IndexeddbPersistence } from 'y-indexeddb';
import NObject from './obj';
import { v4 as uuid } from 'uuid';
class DB {
    userID;
    doc;
    index;
    constructor(userID, provider) {
        this.userID = userID;
        this.userID = userID;
        this.doc = new Y.Doc();
        if (!provider)
            provider = new IndexeddbPersistence('todo_' + userID, this.doc);
        else
            provider.bindState(this.doc.name, this.doc);
        provider.on('synced', () => console.log('Synced'));
        this.index = this.doc.getMap('objects');
    }
    create() {
        const obj = new NObject(this.doc, uuid());
        obj.init(this.userID);
        this.index.set(obj.id, obj.toJSON());
        return obj;
    }
    get(id) {
        try {
            return new NObject(this.doc, id);
        }
        catch {
            return null;
        }
    }
    delete(id) {
        const obj = this.get(id);
        if (!obj)
            return false;
        // Cleanup references
        this.list().forEach(other => {
            if (other.replies.has(id))
                other.removeReply(id);
            if (other.repliesTo.has(id))
                other.removeReplyTo(id);
        });
        this.doc.transact(() => this.index.delete(id));
        return true;
    }
    list = () => Array.from(this.index.keys())
        .map(id => this.get(id))
        .filter((obj) => obj !== null);
    listByTag = (tag) => this.list().filter(obj => obj.tags.includes(tag));
    listByAuthor = (author) => this.list().filter(obj => obj.author === author);
    search = (query) => {
        const q = query.toLowerCase();
        return this.list().filter(obj => obj.name.toLowerCase().includes(q) ||
            obj.tags.some(tag => tag.toLowerCase().includes(q)));
    };
    createReply(parentId, name) {
        const parent = this.get(parentId);
        if (!parent)
            return null;
        const reply = this.create();
        reply.name = name;
        reply.addReplyTo(parentId);
        parent.addReply(reply.id);
        return reply;
    }
    getReplies = (id) => Array.from(this.get(id)?.replies ?? [])
        .map(rid => this.get(rid))
        .filter((r) => r !== null);
    getRepliesTo = (id) => Array.from(this.get(id)?.repliesTo ?? [])
        .map(pid => this.get(pid))
        .filter((p) => p !== null);
    // observe = (fn: Observer): void => this.index.observe(fn);
    // observeObject = (id: string, fn: Observer): void =>
    //     this.get(id)?.observe(fn);
    objText(pageId) {
        const page = this.get(pageId);
        return page ? page.text : null;
    }
    objName(pageId, title) {
        const page = this.get(pageId);
        if (page)
            page.name = title;
    }
    objPublic(pageId, isPublic) {
        const page = this.get(pageId);
        if (page)
            page.public = isPublic;
    }
}
export default DB;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJkYi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZO0FBQ1osT0FBTyxLQUFLLENBQUMsTUFBTSxLQUFLLENBQUM7QUFDekIsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRW5ELE9BQU8sT0FBTyxNQUFNLE9BQU8sQ0FBQztBQUM1QixPQUFPLEVBQUUsRUFBRSxJQUFJLElBQUksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUVsQyxNQUFNLEVBQUU7SUFJaUI7SUFIWixHQUFHLENBQVE7SUFDSixLQUFLLENBQWE7SUFFbEMsWUFBcUIsTUFBYyxFQUFFLFFBQW9EO1FBQXBFLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDL0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUV2QixJQUFJLENBQUMsUUFBUTtZQUNULFFBQVEsR0FBRyxJQUFJLG9CQUFvQixDQUFDLE9BQU8sR0FBRyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDOztZQUVoRSxRQUFRLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVoRCxRQUFRLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFFbkQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsTUFBTTtRQUNGLE1BQU0sR0FBRyxHQUFHLElBQUksT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUMxQyxH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QUFDLElBQUksQ0FBQztJQUNuQyxDQUFDO0lBRUQsT0FBTyxDQUFDLE1BQWEsRUFBRSxLQUFZO1FBQy9CLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDOUIsSUFBSSxJQUFJO1lBQ0osSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUM7SUFDMUIsQ0FBQztJQUVELFNBQVMsQ0FBQyxNQUFhLEVBQUUsUUFBZ0I7UUFDckMsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM5QixJQUFJLElBQUk7WUFDSixJQUFJLENBQUMsTUFBTSxHQUFHLFFBQVEsQ0FBQztJQUMvQixDQUFDO0NBRUo7QUFDRCxlQUFlLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9kYi50c1xuaW1wb3J0ICogYXMgWSBmcm9tICd5anMnO1xuaW1wb3J0IHsgSW5kZXhlZGRiUGVyc2lzdGVuY2UgfSBmcm9tICd5LWluZGV4ZWRkYic7XG5pbXBvcnQgeyBMZXZlbGRiUGVyc2lzdGVuY2UgfSBmcm9tICd5LWxldmVsZGInO1xuaW1wb3J0IE5PYmplY3QgZnJvbSAnLi9vYmonO1xuaW1wb3J0IHsgdjQgYXMgdXVpZCB9IGZyb20gJ3V1aWQnO1xuXG5jbGFzcyBEQiB7XG4gICAgcmVhZG9ubHkgZG9jOiBZLkRvYztcbiAgICBwdWJsaWMgcmVhZG9ubHkgaW5kZXg6IFkuTWFwPGFueT47XG5cbiAgICBjb25zdHJ1Y3RvcihyZWFkb25seSB1c2VySUQ6IHN0cmluZywgcHJvdmlkZXI/OiBJbmRleGVkZGJQZXJzaXN0ZW5jZSB8IExldmVsZGJQZXJzaXN0ZW5jZSkge1xuICAgICAgICB0aGlzLnVzZXJJRCA9IHVzZXJJRDtcbiAgICAgICAgdGhpcy5kb2MgPSBuZXcgWS5Eb2MoKTtcblxuICAgICAgICBpZiAoIXByb3ZpZGVyKVxuICAgICAgICAgICAgcHJvdmlkZXIgPSBuZXcgSW5kZXhlZGRiUGVyc2lzdGVuY2UoJ3RvZG9fJyArIHVzZXJJRCwgdGhpcy5kb2MpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBwcm92aWRlci5iaW5kU3RhdGUodGhpcy5kb2MubmFtZSwgdGhpcy5kb2MpO1xuXG4gICAgICAgIHByb3ZpZGVyLm9uKCdzeW5jZWQnLCAoKSA9PiBjb25zb2xlLmxvZygnU3luY2VkJykpO1xuXG4gICAgICAgIHRoaXMuaW5kZXggPSB0aGlzLmRvYy5nZXRNYXAoJ29iamVjdHMnKTtcbiAgICB9XG5cbiAgICBjcmVhdGUoKTogTk9iamVjdCB7XG4gICAgICAgIGNvbnN0IG9iaiA9IG5ldyBOT2JqZWN0KHRoaXMuZG9jLCB1dWlkKCkpO1xuICAgICAgICBvYmouaW5pdCh0aGlzLnVzZXJJRCk7XG4gICAgICAgIHRoaXMuaW5kZXguc2V0KG9iai5pZCwgb2JqLnRvSlNPTigpKTtcbiAgICAgICAgcmV0dXJuIG9iajtcbiAgICB9XG5cbiAgICBnZXQoaWQ6IHN0cmluZyk6IE5PYmplY3QgfCBudWxsIHtcbiAgICAgICAgdHJ5IHsgcmV0dXJuIG5ldyBOT2JqZWN0KHRoaXMuZG9jLCBpZCk7IH1cbiAgICAgICAgY2F0Y2ggeyByZXR1cm4gbnVsbDsgfVxuICAgIH1cblxuICAgIGRlbGV0ZShpZDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IG9iaiA9IHRoaXMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKCFvYmopIHJldHVybiBmYWxzZTtcblxuICAgICAgICAvLyBDbGVhbnVwIHJlZmVyZW5jZXNcbiAgICAgICAgdGhpcy5saXN0KCkuZm9yRWFjaChvdGhlciA9PiB7XG4gICAgICAgICAgICBpZiAob3RoZXIucmVwbGllcy5oYXMoaWQpKSBvdGhlci5yZW1vdmVSZXBseShpZCk7XG4gICAgICAgICAgICBpZiAob3RoZXIucmVwbGllc1RvLmhhcyhpZCkpIG90aGVyLnJlbW92ZVJlcGx5VG8oaWQpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmRvYy50cmFuc2FjdCgoKSA9PiB0aGlzLmluZGV4LmRlbGV0ZShpZCkpO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBsaXN0ID0gKCk6IE5PYmplY3RbXSA9PlxuICAgICAgICBBcnJheS5mcm9tKHRoaXMuaW5kZXgua2V5cygpKVxuICAgICAgICAgICAgLm1hcChpZCA9PiB0aGlzLmdldChpZCkpXG4gICAgICAgICAgICAuZmlsdGVyKChvYmopOiBvYmogaXMgTk9iamVjdCA9PiBvYmogIT09IG51bGwpO1xuXG4gICAgbGlzdEJ5VGFnID0gKHRhZzogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmxpc3QoKS5maWx0ZXIob2JqID0+IG9iai50YWdzLmluY2x1ZGVzKHRhZykpO1xuXG4gICAgbGlzdEJ5QXV0aG9yID0gKGF1dGhvcjogc3RyaW5nKSA9PlxuICAgICAgICB0aGlzLmxpc3QoKS5maWx0ZXIob2JqID0+IG9iai5hdXRob3IgPT09IGF1dGhvcik7XG5cbiAgICBzZWFyY2ggPSAocXVlcnk6IHN0cmluZyk6IE5PYmplY3RbXSA9PiB7XG4gICAgICAgIGNvbnN0IHEgPSBxdWVyeS50b0xvd2VyQ2FzZSgpO1xuICAgICAgICByZXR1cm4gdGhpcy5saXN0KCkuZmlsdGVyKG9iaiA9PlxuICAgICAgICAgICAgb2JqLm5hbWUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhxKSB8fFxuICAgICAgICAgICAgb2JqLnRhZ3Muc29tZSh0YWcgPT4gdGFnLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMocSkpXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgY3JlYXRlUmVwbHkocGFyZW50SWQ6IHN0cmluZywgbmFtZT86IHN0cmluZyk6IE5PYmplY3QgfCBudWxsIHtcbiAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy5nZXQocGFyZW50SWQpO1xuICAgICAgICBpZiAoIXBhcmVudCkgcmV0dXJuIG51bGw7XG5cbiAgICAgICAgY29uc3QgcmVwbHkgPSB0aGlzLmNyZWF0ZSgpO1xuICAgICAgICByZXBseS5uYW1lID0gbmFtZTtcbiAgICAgICAgcmVwbHkuYWRkUmVwbHlUbyhwYXJlbnRJZCk7XG4gICAgICAgIHBhcmVudC5hZGRSZXBseShyZXBseS5pZCk7XG4gICAgICAgIHJldHVybiByZXBseTtcbiAgICB9XG5cbiAgICBnZXRSZXBsaWVzID0gKGlkOiBzdHJpbmcpOiBOT2JqZWN0W10gPT5cbiAgICAgICAgQXJyYXkuZnJvbSh0aGlzLmdldChpZCk/LnJlcGxpZXMgPz8gW10pXG4gICAgICAgICAgICAubWFwKHJpZCA9PiB0aGlzLmdldChyaWQpKVxuICAgICAgICAgICAgLmZpbHRlcigocik6IHIgaXMgTk9iamVjdCA9PiByICE9PSBudWxsKTtcblxuICAgIGdldFJlcGxpZXNUbyA9IChpZDogc3RyaW5nKTogTk9iamVjdFtdID0+XG4gICAgICAgIEFycmF5LmZyb20odGhpcy5nZXQoaWQpPy5yZXBsaWVzVG8gPz8gW10pXG4gICAgICAgICAgICAubWFwKHBpZCA9PiB0aGlzLmdldChwaWQpKVxuICAgICAgICAgICAgLmZpbHRlcigocCk6IHAgaXMgTk9iamVjdCA9PiBwICE9PSBudWxsKTtcblxuXG4gICAgLy8gb2JzZXJ2ZSA9IChmbjogT2JzZXJ2ZXIpOiB2b2lkID0+IHRoaXMuaW5kZXgub2JzZXJ2ZShmbik7XG4gICAgLy8gb2JzZXJ2ZU9iamVjdCA9IChpZDogc3RyaW5nLCBmbjogT2JzZXJ2ZXIpOiB2b2lkID0+XG4gICAgLy8gICAgIHRoaXMuZ2V0KGlkKT8ub2JzZXJ2ZShmbik7XG5cbiAgICBvYmpUZXh0KHBhZ2VJZDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHBhZ2UgPSB0aGlzLmdldChwYWdlSWQpO1xuICAgICAgICByZXR1cm4gcGFnZSA/IHBhZ2UudGV4dCA6IG51bGw7XG4gICAgfVxuXG4gICAgb2JqTmFtZShwYWdlSWQ6c3RyaW5nLCB0aXRsZTpzdHJpbmcpOnZvaWQge1xuICAgICAgICBjb25zdCBwYWdlID0gdGhpcy5nZXQocGFnZUlkKTtcbiAgICAgICAgaWYgKHBhZ2UpXG4gICAgICAgICAgICBwYWdlLm5hbWUgPSB0aXRsZTtcbiAgICB9XG5cbiAgICBvYmpQdWJsaWMocGFnZUlkOnN0cmluZywgaXNQdWJsaWM6Ym9vbGVhbik6dm9pZCB7XG4gICAgICAgIGNvbnN0IHBhZ2UgPSB0aGlzLmdldChwYWdlSWQpO1xuICAgICAgICBpZiAocGFnZSlcbiAgICAgICAgICAgIHBhZ2UucHVibGljID0gaXNQdWJsaWM7XG4gICAgfVxuXG59XG5leHBvcnQgZGVmYXVsdCBEQjsiXX0=