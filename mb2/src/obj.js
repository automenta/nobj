import * as Y from "yjs";
export default class NObject {
    doc;
    id;
    root;
    constructor(doc, id) {
        this.doc = doc;
        this.id = id;
        this.id = id;
        this.root = doc.getMap(id);
    }
    init(author) {
        const now = Date.now();
        this.doc.transact(() => {
            this.root.set('content', new Y.Text());
            const links = new Y.Map();
            links.set('reply', new Y.Array());
            links.set('replyTo', new Y.Array());
            this.root.set('links', links);
            const meta = new Y.Map();
            meta.set('id', this.id);
            meta.set('name', '?');
            meta.set('created', now);
            meta.set('updated', now);
            meta.set('public', false);
            meta.set('author', author);
            meta.set('tags', new Y.Array());
            this.root.set('metadata', meta);
        });
    }
    // Transactional property access
    transact(fn) {
        return this.doc.transact(() => {
            const result = fn();
            this.root.get('metadata').set('updated', Date.now());
            return result;
        });
    }
    get created() { return this.root.get('metadata').get('created'); }
    get updated() { return this.root.get('metadata').get('updated'); }
    get name() { return this.root.get('metadata').get('name'); }
    set name(v) { this.transact(() => this.root.get('metadata').set('name', v)); }
    get public() { return this.root.get('metadata').get('public'); }
    set public(v) { this.transact(() => this.root.get('metadata').set('public', v)); }
    get author() { return this.root.get('metadata').get('author'); }
    set author(v) { this.transact(() => this.root.get('metadata').set('author', v)); }
    get text() { return this.root.get('content'); }
    setText(newText) {
        this.transact(() => {
            const t = this.text;
            t.delete(0, t.length);
            t.insert(0, newText.toString());
        });
    }
    // Collections with automatic transactions
    get tags() { return this.root.get('metadata').get('tags').toArray(); }
    get replies() { return new Set(this.root.get('links').get('reply')); }
    get repliesTo() { return new Set(this.root.get('links').get('replyTo')); }
    updateCollection(type, value, add) {
        this.transact(() => {
            let arr = type === 'tags'
                ? this.root.get('metadata').get('tags')
                : this.root.get('links').get(type);
            if (add) {
                arr.push([value]);
            }
            else if (!add) {
                const idx = arr.indexOf(value);
                if (idx !== -1)
                    arr.delete(idx, 1);
            }
        });
    }
    // Collection operations
    addTag = (tag) => this.updateCollection('tags', tag, true);
    removeTag = (tag) => this.updateCollection('tags', tag, false);
    addReply = (id) => this.updateCollection('reply', id, true);
    removeReply = (id) => this.updateCollection('reply', id, false);
    addReplyTo = (id) => this.updateCollection('replyTo', id, true);
    removeReplyTo = (id) => this.updateCollection('replyTo', id, false);
    toJSON() {
        return {
            metadata: {
                id: this.id,
                name: this.name,
                created: this.created,
                updated: this.updated,
                public: this.public,
                author: this.author,
                tags: this.tags
            },
            text: this.text.toString(),
            links: {
                reply: this.replies,
                replyTo: this.repliesTo
            }
        };
    }
    observe(fn) {
        this.root.observeDeep(fn);
    }
    unobserve(fn) {
        this.root.unobserveDeep(fn);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JqLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsib2JqLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDO0FBSXpCLE1BQU0sQ0FBQyxPQUFPLE9BQU8sT0FBTztJQUdKO0lBQW1CO0lBRnRCLElBQUksQ0FBYTtJQUVsQyxZQUFvQixHQUFVLEVBQVMsRUFBUztRQUE1QixRQUFHLEdBQUgsR0FBRyxDQUFPO1FBQVMsT0FBRSxHQUFGLEVBQUUsQ0FBTztRQUM1QyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxJQUFJLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRU0sSUFBSSxDQUFDLE1BQWE7UUFDckIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRTtZQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztZQUV2QyxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMxQixLQUFLLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2xDLEtBQUssQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7WUFDcEMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBRTlCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN4QixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN0QixJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN6QixJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUN6QixJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUMxQixJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNwQyxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxnQ0FBZ0M7SUFDeEIsUUFBUSxDQUFJLEVBQVc7UUFDM0IsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUU7WUFDMUIsTUFBTSxNQUFNLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUNyRCxPQUFPLE1BQU0sQ0FBQztRQUNsQixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCxJQUFJLE9BQU8sS0FBWSxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekUsSUFBSSxPQUFPLEtBQVksT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXpFLElBQUksSUFBSSxLQUFZLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRSxJQUFJLElBQUksQ0FBQyxDQUFTLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRXRGLElBQUksTUFBTSxLQUFhLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4RSxJQUFJLE1BQU0sQ0FBQyxDQUFVLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTNGLElBQUksTUFBTSxLQUFZLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2RSxJQUFJLE1BQU0sQ0FBQyxDQUFTLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTFGLElBQUksSUFBSSxLQUFZLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUMs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QyxTQUFTLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBRTVFLE1BQU07UUFDRixPQUFPO1lBQ0gsUUFBUSxFQUFFO2dCQUNOLEVBQUUsRUFBRSxJQUFJLENBQUMsRUFBRTtnQkFDWCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ2YsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO2dCQUNyQixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU87Z0JBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTTtnQkFDbkIsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNO2dCQUNuQixJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7YUFDbEI7WUFDRCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDMUIsS0FBSyxFQUFFO2dCQUNILEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTztnQkFDbkIsT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTO2FBQzFCO1NBQ0osQ0FBQztJQUNOLENBQUM7SUFFRCxPQUFPLENBQUMsRUFBWTtRQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUM5QixDQUFDO0lBRUQsU0FBUyxDQUFDLEVBQVk7UUFDbEIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgWSBmcm9tIFwieWpzXCI7XG5cbnR5cGUgT2JzZXJ2ZXIgPSAoZXZlbnRzOiBZLllFdmVudDxhbnk+W10pID0+IHZvaWQ7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE5PYmplY3Qge1xuICAgIHByaXZhdGUgcmVhZG9ubHkgcm9vdDogWS5NYXA8YW55PjtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgZG9jOiBZLkRvYywgcHVibGljIGlkOnN0cmluZykge1xuICAgICAgICB0aGlzLmlkID0gaWQ7XG4gICAgICAgIHRoaXMucm9vdCA9IGRvYy5nZXRNYXAoaWQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBpbml0KGF1dGhvcjpzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgdGhpcy5kb2MudHJhbnNhY3QoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5yb290LnNldCgnY29udGVudCcsIG5ldyBZLlRleHQoKSk7XG5cbiAgICAgICAgICAgIGNvbnN0IGxpbmtzID0gbmV3IFkuTWFwKCk7XG4gICAgICAgICAgICBsaW5rcy5zZXQoJ3JlcGx5JywgbmV3IFkuQXJyYXkoKSk7XG4gICAgICAgICAgICBsaW5rcy5zZXQoJ3JlcGx5VG8nLCBuZXcgWS5BcnJheSgpKTtcbiAgICAgICAgICAgIHRoaXMucm9vdC5zZXQoJ2xpbmtzJywgbGlua3MpO1xuXG4gICAgICAgICAgICBjb25zdCBtZXRhID0gbmV3IFkuTWFwKCk7XG4gICAgICAgICAgICBtZXRhLnNldCgnaWQnLCB0aGlzLmlkKTtcbiAgICAgICAgICAgIG1ldGEuc2V0KCduYW1lJywgJz8nKTtcbiAgICAgICAgICAgIG1ldGEuc2V0KCdjcmVhdGVkJywgbm93KTtcbiAgICAgICAgICAgIG1ldGEuc2V0KCd1cGRhdGVkJywgbm93KTtcbiAgICAgICAgICAgIG1ldGEuc2V0KCdwdWJsaWMnLCBmYWxzZSk7XG4gICAgICAgICAgICBtZXRhLnNldCgnYXV0aG9yJywgYXV0aG9yKTtcbiAgICAgICAgICAgIG1ldGEuc2V0KCd0YWdzJywgbmV3IFkuQXJyYXkoKSk7XG4gICAgICAgICAgICB0aGlzLnJvb3Quc2V0KCdtZXRhZGF0YScsIG1ldGEpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBUcmFuc2FjdGlvbmFsIHByb3BlcnR5IGFjY2Vzc1xuICAgIHByaXZhdGUgdHJhbnNhY3Q8VD4oZm46ICgpID0+IFQpOiBUIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZG9jLnRyYW5zYWN0KCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGZuKCk7XG4gICAgICAgICAgICB0aGlzLnJvb3QuZ2V0KCdtZXRhZGF0YScpLnNldCgndXBkYXRlZCcsIERhdGUubm93KCkpO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZ2V0IGNyZWF0ZWQoKTpudW1iZXIgeyByZXR1cm4gdGhpcy5yb290LmdldCgnbWV0YWRhdGEnKS5nZXQoJ2NyZWF0ZWQnKTsgfVxuICAgIGdldCB1cGRhdGVkKCk6bnVtYmVyIHsgcmV0dXJuIHRoaXMucm9vdC5nZXQoJ21ldGFkYXRhJykuZ2V0KCd1cGRhdGVkJyk7IH1cblxuICAgIGdldCBuYW1lKCk6c3RyaW5nIHsgcmV0dXJuIHRoaXMucm9vdC5nZXQoJ21ldGFkYXRhJykuZ2V0KCduYW1lJyk7IH1cbiAgICBzZXQgbmFtZSh2OiBzdHJpbmcpIHsgdGhpcy50cmFuc2FjdCgoKSA9PiB0aGlzLnJvb3QuZ2V0KCdtZXRhZGF0YScpLnNldCgnbmFtZScsIHYpKTsgfVxuXG4gICAgZ2V0IHB1YmxpYygpOmJvb2xlYW4geyByZXR1cm4gdGhpcy5yb290LmdldCgnbWV0YWRhdGEnKS5nZXQoJ3B1YmxpYycpOyB9XG4gICAgc2V0IHB1YmxpYyh2OiBib29sZWFuKSB7IHRoaXMudHJhbnNhY3QoKCkgPT4gdGhpcy5yb290LmdldCgnbWV0YWRhdGEnKS5zZXQoJ3B1YmxpYycsIHYpKTsgfVxuXG4gICAgZ2V0IGF1dGhvcigpOnN0cmluZyB7IHJldHVybiB0aGlzLnJvb3QuZ2V0KCdtZXRhZGF0YScpLmdldCgnYXV0aG9yJyk7IH1cbiAgICBzZXQgYXV0aG9yKHY6IHN0cmluZykgeyB0aGlzLnRyYW5zYWN0KCgpID0+IHRoaXMucm9vdC5nZXQoJ21ldGFkYXRhJykuc2V0KCdhdXRob3InLCB2KSk7IH1cblxuICAgIGdldCB0ZXh0KCk6WS5UZXh0IHsgcmV0dXJuIHRoaXMucm9vdC5nZXQoJ2NvbnRlbnQnKTsgfVxuICAgIHNldFRleHQobmV3VGV4dDogc3RyaW5nIHwgWS5UZXh0KSB7XG4gICAgICAgIHRoaXMudHJhbnNhY3QoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgdCA9IHRoaXMudGV4dDtcbiAgICAgICAgICAgIHQuZGVsZXRlKDAsIHQubGVuZ3RoKTtcbiAgICAgICAgICAgIHQuaW5zZXJ0KDAsIG5ld1RleHQudG9TdHJpbmcoKSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENvbGxlY3Rpb25zIHdpdGggYXV0b21hdGljIHRyYW5zYWN0aW9uc1xuICAgIGdldCB0YWdzKCk6QXJyYXk8c3RyaW5nPiB7IHJldHVybiB0aGlzLnJvb3QuZ2V0KCdtZXRhZGF0YScpLmdldCgndGFncycpLnRvQXJyYXkoKTsgfVxuICAgIGdldCByZXBsaWVzKCk6U2V0PHN0cmluZz4geyByZXR1cm4gbmV3IFNldCh0aGlzLnJvb3QuZ2V0KCdsaW5rcycpLmdldCgncmVwbHknKSk7IH1cbiAgICBnZXQgcmVwbGllc1RvKCk6U2V0PHN0cmluZz4geyByZXR1cm4gbmV3IFNldCh0aGlzLnJvb3QuZ2V0KCdsaW5rcycpLmdldCgncmVwbHlUbycpKTsgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVDb2xsZWN0aW9uKHR5cGU6ICd0YWdzJyB8ICdyZXBseScgfCAncmVwbHlUbycsIHZhbHVlOiBzdHJpbmcsIGFkZDogYm9vbGVhbikge1xuICAgICAgICB0aGlzLnRyYW5zYWN0KCgpID0+IHtcbiAgICAgICAgICAgIGxldCBhcnIgPSB0eXBlID09PSAndGFncydcbiAgICAgICAgICAgICAgICA/IHRoaXMucm9vdC5nZXQoJ21ldGFkYXRhJykuZ2V0KCd0YWdzJylcbiAgICAgICAgICAgICAgICA6IHRoaXMucm9vdC5nZXQoJ2xpbmtzJykuZ2V0KHR5cGUpO1xuXG4gICAgICAgICAgICBpZiAoYWRkKSB7XG4gICAgICAgICAgICAgICAgYXJyLnB1c2goW3ZhbHVlXSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKCFhZGQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBpZHggPSBhcnIuaW5kZXhPZih2YWx1ZSk7XG4gICAgICAgICAgICAgICAgaWYgKGlkeCAhPT0gLTEpIGFyci5kZWxldGUoaWR4LCAxKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQ29sbGVjdGlvbiBvcGVyYXRpb25zXG4gICAgYWRkVGFnID0gKHRhZzogc3RyaW5nKSA9PiB0aGlzLnVwZGF0ZUNvbGxlY3Rpb24oJ3RhZ3MnLCB0YWcsIHRydWUpO1xuICAgIHJlbW92ZVRhZyA9ICh0YWc6IHN0cmluZykgPT4gdGhpcy51cGRhdGVDb2xsZWN0aW9uKCd0YWdzJywgdGFnLCBmYWxzZSk7XG4gICAgYWRkUmVwbHkgPSAoaWQ6IHN0cmluZykgPT4gdGhpcy51cGRhdGVDb2xsZWN0aW9uKCdyZXBseScsIGlkLCB0cnVlKTtcbiAgICByZW1vdmVSZXBseSA9IChpZDogc3RyaW5nKSA9PiB0aGlzLnVwZGF0ZUNvbGxlY3Rpb24oJ3JlcGx5JywgaWQsIGZhbHNlKTtcbiAgICBhZGRSZXBseVRvID0gKGlkOiBzdHJpbmcpID0+IHRoaXMudXBkYXRlQ29sbGVjdGlvbigncmVwbHlUbycsIGlkLCB0cnVlKTtcbiAgICByZW1vdmVSZXBseVRvID0gKGlkOiBzdHJpbmcpID0+IHRoaXMudXBkYXRlQ29sbGVjdGlvbigncmVwbHlUbycsIGlkLCBmYWxzZSk7XG5cbiAgICB0b0pTT04oKTogYW55IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgICAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgICAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICAgICAgICAgIGNyZWF0ZWQ6IHRoaXMuY3JlYXRlZCxcbiAgICAgICAgICAgICAgICB1cGRhdGVkOiB0aGlzLnVwZGF0ZWQsXG4gICAgICAgICAgICAgICAgcHVibGljOiB0aGlzLnB1YmxpYyxcbiAgICAgICAgICAgICAgICBhdXRob3I6IHRoaXMuYXV0aG9yLFxuICAgICAgICAgICAgICAgIHRhZ3M6IHRoaXMudGFnc1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHRleHQ6IHRoaXMudGV4dC50b1N0cmluZygpLFxuICAgICAgICAgICAgbGlua3M6IHtcbiAgICAgICAgICAgICAgICByZXBseTogdGhpcy5yZXBsaWVzLFxuICAgICAgICAgICAgICAgIHJlcGx5VG86IHRoaXMucmVwbGllc1RvXG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgb2JzZXJ2ZShmbjogT2JzZXJ2ZXIpIHtcbiAgICAgICAgdGhpcy5yb290Lm9ic2VydmVEZWVwKGZuKTtcbiAgICB9XG5cbiAgICB1bm9ic2VydmUoZm46IE9ic2VydmVyKSB7XG4gICAgICAgIHRoaXMucm9vdC51bm9ic2VydmVEZWVwKGZuKTtcbiAgICB9XG59Il19