import { WebrtcProvider } from 'y-webrtc';
import { events } from './events';
class Network {
    channel;
    db;
    docsShared;
    metrics;
    net;
    signalingServers;
    constructor(channel, db) {
        this.channel = channel;
        this.db = db;
        this.docsShared = new Set();
        this.metrics = {
            messagesSent: 0,
            messagesReceived: 0,
            bytesTransferred: 0,
            peersConnected: new Set(),
        };
        this.db.doc.on('update', (update, origin) => {
            this.metrics.bytesTransferred += update.length;
            if (origin === this.net) {
                this.metrics.messagesSent++;
                this.emit('message-sent', { bytes: update.length });
            }
            else {
                this.metrics.messagesReceived++;
                this.emit('message-received', { bytes: update.length });
            }
        });
        //TODO load persisted signaling servers
        this.signalingServers = ['ws://localhost:4444']; // Default server
        this.reset();
    }
    reset() {
        if (this.net)
            this.net.destroy();
        /** https://github.com/yjs/y-webrtc
         *  https://github.com/feross/simple-peer#peer--new-peeropts */
        this.net = new WebrtcProvider(this.channel, this.db.doc, {
            signaling: this.signalingServers,
        });
        this.net.awareness.setLocalStateField('user', {
            id: this.db.userID,
            name: 'Anonymous',
            color: '#' + Math.floor(Math.random() * 16777215).toString(16),
        });
        // Track peer connections
        this.net.on('peers', ({ added, removed }) => {
            added.forEach(id => {
                this.metrics.peersConnected.add(id);
                this.emit('peer-connected', { peerId: id });
            });
            removed.forEach(id => {
                this.metrics.peersConnected.delete(id);
                this.emit('peer-disconnected', { peerId: id });
            });
        });
        this.net.awareness.on('change', changes => this.emit('awareness-update', { changes }));
    }
    addBootstrap(url) {
        if (!this.signalingServers.includes(url)) {
            this.signalingServers.push(url);
            this.reset(); // Reinitialize with the new list
        }
    }
    removeBootstrap(url) {
        const index = this.signalingServers.indexOf(url);
        if (index !== -1) {
            this.signalingServers.splice(index, 1);
            this.reset(); // Reinitialize with the updated list
        }
        else
            throw "Bootstrap not found";
    }
    user() { return this.awareness().getLocalState().user; }
    awareness() { return this.net.awareness; }
    shareDocument(pageId) {
        if (!this.docsShared.has(pageId)) {
            const page = this.db.get(pageId);
            if (page && page.public) {
                // Assuming that sharing a document involves ensuring its content is synced
                // Since Yjs syncs all shared content in the document, no action is needed here
                // However, if you have separate Y.Docs per page, initialize and connect them here
                this.docsShared.add(pageId);
                console.log(`Document ${pageId} is now shared.`);
                this.emit('document-shared', { pageId });
            }
            else
                console.warn(`Cannot share document ${pageId} as it is not public.`);
        }
    }
    unshareDocument(pageId) {
        if (this.docsShared.has(pageId)) {
            // Assuming that unsharing involves removing its content from synchronization
            // Since Yjs syncs all shared content in the document, you might need to remove or isolate it
            // If using separate Y.Docs per page, disconnect the provider here
            this.docsShared.delete(pageId);
            console.log(`Document ${pageId} is now unshared.`);
            this.emit('document-unshared', { pageId });
        }
    }
    getNetworkStats() {
        return {
            ...this.metrics,
            peersConnected: Array.from(this.metrics.peersConnected),
            connectedPeersCount: this.metrics.peersConnected.size,
            awareness: Array.from(this.net.awareness.getStates().entries()).map(([clientId, state]) => ({
                clientId,
                metadata: state.user,
                lastActive: Date.now(), // Placeholder for actual last active timestamp
            })),
        };
    }
    emit(type, data) {
        events.emit('networkActivity', {
            detail: {
                type,
                timestamp: Date.now(),
                data: {
                    ...data,
                    stats: this.getNetworkStats(),
                }
            }
        });
    }
}
export default Network;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibmV0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxVQUFVLENBQUM7QUFFeEMsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLFVBQVUsQ0FBQztBQUVoQyxNQUFNLE9BQU87SUFFQSxPQUFPLENBQVM7SUFDakIsRUFBRSxDQUFLO0lBQ1AsVUFBVSxDQUFjO0lBQ2YsT0FBTyxDQUt0QjtJQUNNLEdBQUcsQ0FBaUI7SUFDWCxnQkFBZ0IsQ0FBVztJQUU1QyxZQUFZLE9BQWMsRUFBRSxFQUFLO1FBQzdCLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBRWIsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQzVCLElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDWCxZQUFZLEVBQUUsQ0FBQztZQUNmLGdCQUFnQixFQUFFLENBQUM7WUFDbkIsZ0JBQWdCLEVBQUUsQ0FBQztZQUNuQixjQUFjLEVBQUUsSUFBSSxHQUFHLEVBQUU7U0FDNUIsQ0FBQztRQUVGLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLEVBQUU7WUFDeEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxnQkFBZ0IsSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDO1lBQy9DLElBQUksTUFBTSxLQUFLLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDdEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRSxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDeEQsQ0FBQztpQkFBTSxDQUFDO2dCQUNKLElB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O1xuaW1wb3J0IERCIGZyb20gXCIuL2RiXCI7XG5pbXBvcnQge2V2ZW50c30gZnJvbSAnLi9ldmVudHMnO1xuXG5jbGFzcyBOZXR3b3JrIHtcblxuICAgIHJlYWRvbmx5IGNoYW5uZWw6IHN0cmluZztcbiAgICBwcml2YXRlIGRiOiBEQjtcbiAgICBwcml2YXRlIGRvY3NTaGFyZWQ6IFNldDxzdHJpbmc+O1xuICAgIHByaXZhdGUgcmVhZG9ubHkgbWV0cmljczoge1xuICAgICAgICBieXRlc1RyYW5zZmVycmVkOiBudW1iZXI7XG4gICAgICAgIG1lc3NhZ2VzU2VudDogbnVtYmVyO1xuICAgICAgICBtZXNzYWdlc1JlY2VpdmVkOiBudW1iZXI7XG4gICAgICAgIHBlZXJzQ29ubmVjdGVkOiBTZXQ8YW55PlxuICAgIH07XG4gICAgcHJpdmF0ZSBuZXQ6IFdlYnJ0Y1Byb3ZpZGVyO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgc2lnbmFsaW5nU2VydmVyczogc3RyaW5nW107XG5cbiAgICBjb25zdHJ1Y3RvcihjaGFubmVsOnN0cmluZywgZGI6REIpIHtcbiAgICAgICAgdGhpcy5jaGFubmVsID0gY2hhbm5lbDtcbiAgICAgICAgdGhpcy5kYiA9IGRiO1xuXG4gICAgICAgIHRoaXMuZG9jc1NoYXJlZCA9IG5ldyBTZXQoKTtcbiAgICAgICAgdGhpcy5tZXRyaWNzID0ge1xuICAgICAgICAgICAgbWVzc2FnZXNTZW50OiAwLFxuICAgICAgICAgICAgbWVzc2FnZXNSZWNlaXZlZDogMCxcbiAgICAgICAgICAgIGJ5dGVzVHJhbnNmZXJyZWQ6IDAsXG4gICAgICAgICAgICBwZWVyc0Nvbm5lY3RlZDogbmV3IFNldCgpLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuZGIuZG9jLm9uKCd1cGRhdGUnLCAodXBkYXRlLCBvcmlnaW4pID0+IHtcbiAgICAgICAgICAgIHRoaXMubWV0cmljcy5ieXRlc1RyYW5zZmVycmVkICs9IHVwZGF0ZS5sZW5ndGg7XG4gICAgICAgICAgICBpZiAob3JpZ2luID09PSB0aGlzLm5ldCkge1xuICAgICAgICAgICAgICAgIHRoaXMubWV0cmljcy5tZXNzYWdlc1NlbnQrKztcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoJ21lc3NhZ2Utc2VudCcsIHsgYnl0ZXM6IHVwZGF0ZS5sZW5ndGggfSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMubWV0cmljcy5tZXNzYWdlc1JlY2VpdmVkKys7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdtZXNzYWdlLXJlY2VpdmVkJywgeyBieXRlczogdXBkYXRlLmxlbmd0aCB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy9UT0RPIGxvYWQgcGVyc2lzdGVkIHNpZ25hbGluZyBzZXJ2ZXJzXG4gICAgICAgIHRoaXMuc2lnbmFsaW5nU2VydmVycyA9IFsnd3M6Ly9sb2NhbGhvc3Q6NDQ0NCddOyAvLyBEZWZhdWx0IHNlcnZlclxuXG4gICAgICAgIHRoaXMucmVzZXQoKTtcbiAgICB9XG5cbiAgICByZXNldCgpIHtcbiAgICAgICAgaWYgKHRoaXMubmV0KVxuICAgICAgICAgICAgdGhpcy5uZXQuZGVzdHJveSgpO1xuXG4gICAgICAgIC8qKiBodHRwczovL2dpdGh1Yi5jb20veWpzL3ktd2VicnRjXG4gICAgICAgICAqICBodHRwczovL2dpdGh1Yi5jb20vZmVyb3NzL3NpbXBsZS1wZWVyI3BlZXItLW5ldy1wZWVyb3B0cyAqL1xuICAgICAgICB0aGlzLm5ldCA9IG5ldyBXZWJydGNQcm92aWRlcih0aGlzLmNoYW5uZWwsIHRoaXMuZGIuZG9jLCB7XG4gICAgICAgICAgICBzaWduYWxpbmc6IHRoaXMuc2lnbmFsaW5nU2VydmVycyxcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMubmV0LmF3YXJlbmVzcy5zZXRMb2NhbFN0YXRlRmllbGQoJ3VzZXInLCB7XG4gICAgICAgICAgICBpZDogdGhpcy5kYi51c2VySUQsXG4gICAgICAgICAgICBuYW1lOiAnQW5vbnltb3VzJyxcbiAgICAgICAgICAgIGNvbG9yOiAnIycgKyBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAxNjc3NzIxNSkudG9TdHJpbmcoMTYpLFxuICAgICAgICB9KTtcbiAgICAgICAgLy8gVHJhY2sgcGVlciBjb25uZWN0aW9uc1xuICAgICAgICB0aGlzLm5ldC5vbigncGVlcnMnLCAoe2FkZGVkLCByZW1vdmVkfSkgPT4ge1xuICAgICAgICAgICAgYWRkZWQuZm9yRWFjaChpZCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5tZXRyaWNzLnBlZXJzQ29ubmVjdGVkLmFkZChpZCk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdwZWVyLWNvbm5lY3RlZCcsIHtwZWVySWQ6IGlkfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJlbW92ZWQuZm9yRWFjaChpZCA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5tZXRyaWNzLnBlZXJzQ29ubmVjdGVkLmRlbGV0ZShpZCk7XG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KCdwZWVyLWRpc2Nvbm5lY3RlZCcsIHtwZWVySWQ6IGlkfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5uZXQuYXdhcmVuZXNzLm9uKCdjaGFuZ2UnLCBjaGFuZ2VzID0+IHRoaXMuZW1pdCgnYXdhcmVuZXNzLXVwZGF0ZScsIHtjaGFuZ2VzfSkpO1xuICAgIH1cblxuICAgIGFkZEJvb3RzdHJhcCh1cmw6c3RyaW5nKSB7XG4gICAgICAgIGlmICghdGhpcy5zaWduYWxpbmdTZXJ2ZXJzLmluY2x1ZGVzKHVybCkpIHtcbiAgICAgICAgICAgIHRoaXMuc2lnbmFsaW5nU2VydmVycy5wdXNoKHVybCk7XG4gICAgICAgICAgICB0aGlzLnJlc2V0KCk7IC8vIFJlaW5pdGlhbGl6ZSB3aXRoIHRoZSBuZXcgbGlzdFxuICAgICAgICB9XG4gICAgfVxuXG4gICAgcmVtb3ZlQm9vdHN0cmFwKHVybDpzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLnNpZ25hbGluZ1NlcnZlcnMuaW5kZXhPZih1cmwpO1xuICAgICAgICBpZiAoaW5kZXggIT09IC0xKSB7XG4gICAgICAgICAgICB0aGlzLnNpZ25hbGluZ1NlcnZlcnMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICAgICAgICAgIHRoaXMucmVzZXQoKTsgLy8gUmVpbml0aWFsaXplIHdpdGggdGhlIHVwZGF0ZWQgbGlzdFxuICAgICAgICB9IGVsc2VcbiAgICAgICAgICAgIHRocm93IFwiQm9vdHN0cmFwIG5vdCBmb3VuZFwiO1xuICAgIH1cblxuICAgIHVzZXIoKSB7IHJldHVybiB0aGlzLmF3YXJlbmVzcygpLmdldExvY2FsU3RhdGUoKS51c2VyOyB9XG4gICAgYXdhcmVuZXNzKCkgeyByZXR1cm4gdGhpcy5uZXQuYXdhcmVuZXNzOyB9XG5cbiAgICBzaGFyZURvY3VtZW50KHBhZ2VJZDogc3RyaW5nKSB7XG4gICAgICAgIGlmICghdGhpcy5kb2NzU2hhcmVkLmhhcyhwYWdlSWQpKSB7XG4gICAgICAgICAgICBjb25zdCBwYWdlID0gdGhpcy5kYi5nZXQocGFnZUlkKTtcbiAgICAgICAgICAgIGlmIChwYWdlICYmIHBhZ2UucHVibGljKSB7XG4gICAgICAgICAgICAgICAgLy8gQXNzdW1pbmcgdGhhdCBzaGFyaW5nIGEgZG9jdW1lbnQgaW52b2x2ZXMgZW5zdXJpbmcgaXRzIGNvbnRlbnQgaXMgc3luY2VkXG4gICAgICAgICAgICAgICAgLy8gU2luY2UgWWpzIHN5bmNzIGFsbCBzaGFyZWQgY29udGVudCBpbiB0aGUgZG9jdW1lbnQsIG5vIGFjdGlvbiBpcyBuZWVkZWQgaGVyZVxuICAgICAgICAgICAgICAgIC8vIEhvd2V2ZXIsIGlmIHlvdSBoYXZlIHNlcGFyYXRlIFkuRG9jcyBwZXIgcGFnZSwgaW5pdGlhbGl6ZSBhbmQgY29ubmVjdCB0aGVtIGhlcmVcbiAgICAgICAgICAgICAgICB0aGlzLmRvY3NTaGFyZWQuYWRkKHBhZ2VJZCk7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coYERvY3VtZW50ICR7cGFnZUlkfSBpcyBub3cgc2hhcmVkLmApO1xuICAgICAgICAgICAgICAgIHRoaXMuZW1pdCgnZG9jdW1lbnQtc2hhcmVkJywgeyBwYWdlSWQgfSk7XG4gICAgICAgICAgICB9IGVsc2VcbiAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oYENhbm5vdCBzaGFyZSBkb2N1bWVudCAke3BhZ2VJZH0gYXMgaXQgaXMgbm90IHB1YmxpYy5gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVuc2hhcmVEb2N1bWVudChwYWdlSWQ6c3RyaW5nKSB7XG4gICAgICAgIGlmICh0aGlzLmRvY3NTaGFyZWQuaGFzKHBhZ2VJZCkpIHtcbiAgICAgICAgICAgIC8vIEFzc3VtaW5nIHRoYXQgdW5zaGFyaW5nIGludm9sdmVzIHJlbW92aW5nIGl0cyBjb250ZW50IGZyb20gc3luY2hyb25pemF0aW9uXG4gICAgICAgICAgICAvLyBTaW5jZSBZanMgc3luY3MgYWxsIHNoYXJlZCBjb250ZW50IGluIHRoZSBkb2N1bWVudCwgeW91IG1pZ2h0IG5lZWQgdG8gcmVtb3ZlIG9yIGlzb2xhdGUgaXRcbiAgICAgICAgICAgIC8vIElmIHVzaW5nIHNlcGFyYXRlIFkuRG9jcyBwZXIgcGFnZSwgZGlzY29ubmVjdCB0aGUgcHJvdmlkZXIgaGVyZVxuICAgICAgICAgICAgdGhpcy5kb2NzU2hhcmVkLmRlbGV0ZShwYWdlSWQpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coYERvY3VtZW50ICR7cGFnZUlkfSBpcyBub3cgdW5zaGFyZWQuYCk7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2RvY3VtZW50LXVuc2hhcmVkJywgeyBwYWdlSWQgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXROZXR3b3JrU3RhdHMoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi50aGlzLm1ldHJpY3MsXG4gICAgICAgICAgICBwZWVyc0Nvbm5lY3RlZDogQXJyYXkuZnJvbSh0aGlzLm1ldHJpY3MucGVlcnNDb25uZWN0ZWQpLFxuICAgICAgICAgICAgY29ubmVjdGVkUGVlcnNDb3VudDogdGhpcy5tZXRyaWNzLnBlZXJzQ29ubmVjdGVkLnNpemUsXG4gICAgICAgICAgICBhd2FyZW5lc3M6IEFycmF5LmZyb20odGhpcy5uZXQuYXdhcmVuZXNzLmdldFN0YXRlcygpLmVudHJpZXMoKSkubWFwKFxuICAgICAgICAgICAgICAgIChbY2xpZW50SWQsIHN0YXRlXSkgPT4gKHtcbiAgICAgICAgICAgICAgICAgICAgY2xpZW50SWQsXG4gICAgICAgICAgICAgICAgICAgIG1ldGFkYXRhOiBzdGF0ZS51c2VyLFxuICAgICAgICAgICAgICAgICAgICBsYXN0QWN0aXZlOiBEYXRlLm5vdygpLCAvLyBQbGFjZWhvbGRlciBmb3IgYWN0dWFsIGxhc3QgYWN0aXZlIHRpbWVzdGFtcFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApLFxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGVtaXQodHlwZSwgZGF0YSkge1xuICAgICAgICBldmVudHMuZW1pdCgnbmV0d29ya0FjdGl2aXR5Jywge1xuICAgICAgICAgICAgZGV0YWlsOiB7XG4gICAgICAgICAgICAgICAgdHlwZSxcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgICAgICAgZGF0YToge1xuICAgICAgICAgICAgICAgICAgICAuLi5kYXRhLFxuICAgICAgICAgICAgICAgICAgICBzdGF0czogdGhpcy5nZXROZXR3b3JrU3RhdHMoKSxcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTmV0d29yaztcbiJdfQ==